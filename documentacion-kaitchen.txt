


================================================================================


ARCHIVO: README.md

# 🍳 k[AI]tchen - Sistema de Gestión de Menús Familiares

Sistema inteligente de planificación de comidas para familias, con generación automática de menús personalizados usando IA y visualización optimizada para TV de cocina.

## 🌟 Características

### ✨ Funcionalidades Principales

- **Perfiles Familiares Detallados**: Gestiona perfiles individuales para adultos y niños con:
  - Preferencias alimentarias
  - Alergias e intolerancias
  - Ingredientes favoritos y rechazados
  - Objetivos nutricionales
  - Nivel de exigencia (niños)

- **Extracción Automática de Recetas**: 
  - Extrae recetas desde cualquier URL web
  - Detecta automáticamente ingredientes e instrucciones
  - Soporta múltiples formatos y sitios web
  - Almacenamiento en base de datos local

- **Generación Inteligente de Menús con IA**:
  - Usa Claude (Anthropic) para generar menús semanales
  - Considera TODAS las preferencias y restricciones familiares
  - Balance nutricional automático
  - Adaptaciones para cada miembro de la familia
  - Lista de compra generada automáticamente

- **Vista TV-Friendly**:
  - Interfaz optimizada para pantallas grandes
  - Visualización clara desde la distancia
  - Actualización automática
  - Navegación semanal

## 📋 Requisitos

- Python 3.8+
- Cuenta de Anthropic (para generación de menús con IA)
- Navegador web moderno
- (Opcional) TV inteligente o dispositivo de streaming para la vista de cocina

## 🚀 Instalación

### 1. Clonar o descargar el proyecto

```bash
cd /home/claude
```

### 2. Instalar dependencias

```bash
pip install -r requirements.txt
```

### 3. Configurar variables de entorno

```bash
# Copiar el archivo de ejemplo
cp .env.example .env

# Editar .env y añadir tu API key de Anthropic
# ANTHROPIC_API_KEY=tu_api_key_aqui
```

Para obtener una API key de Anthropic:
1. Visita https://console.anthropic.com/
2. Crea una cuenta o inicia sesión
3. Ve a la sección "API Keys"
4. Crea una nueva API key
5. Copia la key al archivo .env

### 4. Inicializar la base de datos

```bash
python init.py
```

Este script:
- Crea la base de datos SQLite
- Opcionalmente añade perfiles de ejemplo
- Verifica la configuración de la API key

## 💻 Uso

### Iniciar el Servidor

```bash
python app.py
```

El servidor se iniciará en http://localhost:7000

### Interfaces Disponibles

#### 1. Panel de Administración
**URL**: http://localhost:7000

Funciones:
- ✅ Gestionar perfiles de adultos y niños
- ✅ Extraer recetas desde URLs
- ✅ Generar menús semanales con IA
- ✅ Ver y gestionar menús generados
- ✅ Calificar días del menú
- ✅ Regenerar días específicos

#### 2. Vista de TV
**URL**: http://localhost:7000/tv

Características:
- 📺 Diseño optimizado para pantallas grandes
- 🔄 Actualización automática cada 5 minutos
- 📅 Navegación por días de la semana
- 🎨 Interfaz atractiva y fácil de leer desde lejos

## 📱 Guía de Uso Rápido

### 1. Configurar Perfiles Familiares

1. Ve a la pestaña "Familia"
2. Añade perfiles para cada adulto:
   - Nombre, edad
   - Objetivo alimentario
   - Preferencias culinarias
   - Alergias e intolerancias
   - Ingredientes favoritos y rechazados

3. Añade perfiles para cada niño:
   - Nombre, edad
   - Nivel de exigencia
   - Ingredientes que acepta/rechaza
   - Texturas que no le gustan
   - Alergias e intolerancias

### 2. Añadir Recetas (Opcional)

1. Ve a la pestaña "Recetas"
2. Pega la URL de una receta
3. Haz clic en "Extraer Receta"
4. El sistema extraerá automáticamente:
   - Título
   - Ingredientes
   - Instrucciones
   - Tiempo de preparación

**Ejemplo de URLs compatibles**:
- Blogs de cocina españoles (Recetas de Rechupete, Anna Recetas)
- Sitios internacionales (AllRecipes, Food Network)
- Blogs personales con recetas estructuradas

### 3. Generar Menú Semanal

1. Ve a la pestaña "Menú Semanal"
2. Haz clic en "✨ Generar Menú con IA"
3. Espera 15-30 segundos
4. El sistema generará un menú que considera:
   - Todas las preferencias familiares
   - Alergias e intolerancias
   - Balance nutricional
   - Variedad de ingredientes
   - Facilidad de preparación

### 4. Ver en TV de Cocina

1. Ve a la pestaña "Vista TV"
2. Copia la URL mostrada
3. Abre esa URL en el navegador de tu TV
4. El menú se mostrará en formato grande y claro

**Tip**: Si tu TV tiene navegador web, simplemente accede desde ahí. Si no, usa un Chromecast, Fire TV Stick, o cualquier dispositivo de streaming.

## 🏗️ Arquitectura del Sistema

```
family-kitchen-menu/
├── app.py                 # Servidor Flask principal
├── database.py            # Gestión de base de datos SQLite
├── recipe_extractor.py    # Extracción de recetas desde URLs
├── menu_generator.py      # Generador de menús con IA (Claude)
├── init.py               # Script de inicialización
├── requirements.txt       # Dependencias Python
├── .env.example          # Ejemplo de configuración
├── templates/
│   ├── index.html        # Interfaz de administración
│   └── tv_display.html   # Vista para TV
├── static/
│   └── js/
│       └── app.js        # Lógica frontend
└── family_kitchen.db     # Base de datos SQLite (se crea automáticamente)
```

## 🔧 API Endpoints

La aplicación expone una API REST completa. Para documentación detallada, consulta **[API_DOCUMENTATION.md](API_DOCUMENTATION.md)**.

### Endpoints Principales

**Perfiles de Adultos**
- `GET /api/adults` - Obtener todos los adultos
- `POST /api/adults` - Añadir adulto
- `DELETE /api/adults/<id>` - Eliminar adulto

**Perfiles de Niños**
- `GET /api/children` - Obtener todos los niños
- `POST /api/children` - Añadir niño
- `DELETE /api/children/<id>` - Eliminar niño

**Recetas**
- `GET /api/recipes` - Obtener todas las recetas
- `POST /api/recipes/extract` - Extraer receta desde URL
- `POST /api/recipes/batch` - Extraer múltiples recetas
- `GET /api/recipes/search` - Buscar receta por título
- `DELETE /api/recipes/<id>` - Eliminar receta

**Menús**
- `POST /api/menu/generate` - Generar menú semanal con IA
- `GET /api/menu/latest` - Obtener último menú generado
- `GET /api/menu/current-week` - Obtener menú de la semana actual
- `GET /api/menu/week/<date>` - Obtener menú de semana específica
- `GET /api/menu/all` - Obtener todos los menús
- `POST /api/menu/rate-day` - Calificar un día del menú
- `POST /api/menu/regenerate-day` - Regenerar un día específico

**Configuración**
- `GET /api/settings` - Obtener configuración actual
- `POST /api/settings` - Guardar configuración
- `POST /api/settings/test` - Probar API key

Ver **[API_DOCUMENTATION.md](API_DOCUMENTATION.md)** para documentación completa con ejemplos.

## 🎨 Personalización

### Modificar Estilos de la Vista TV

Edita `templates/tv_display.html`:
- Cambia los colores en las variables CSS
- Ajusta tamaños de fuente
- Modifica el layout de las tarjetas

### Añadir Nuevas Fuentes de Recetas

Edita `recipe_extractor.py`:
- Añade patrones de extracción específicos para nuevos sitios
- Mejora la detección de ingredientes
- Añade soporte para nuevos formatos

### Personalizar Prompts de IA

Edita `menu_generator.py`:
- Modifica el prompt base en `_build_menu_prompt()`
- Añade restricciones adicionales
- Ajusta el formato de salida

## 🐛 Solución de Problemas

### Error: "ANTHROPIC_API_KEY no configurada"
**Solución**: 
1. Verifica que el archivo `.env` existe
2. Asegúrate de que contiene `ANTHROPIC_API_KEY=tu_key_real`
3. Reinicia el servidor

### Las recetas no se extraen correctamente
**Solución**:
- Verifica que la URL es accesible
- Algunos sitios bloquean scraping - prueba con URLs diferentes
- Usa el modo de extracción por lotes para múltiples URLs

### El menú no se muestra en la TV
**Solución**:
1. Verifica que el servidor está corriendo
2. Usa la IP local de tu ordenador en lugar de localhost
   - Ejemplo: `http://192.168.1.100:7000/tv`
3. Asegúrate de que la TV y el ordenador están en la misma red
4. Verifica la configuración de CORS si accedes desde otro dispositivo

### Error de conexión a la base de datos
**Solución**:
```bash
# Eliminar y recrear la base de datos
rm family_kitchen.db
python init.py
```

## 🔐 Seguridad

- ⚠️ **NO** compartas tu archivo `.env` con tu API key
- El sistema es para uso local/doméstico
- Si expones a Internet, añade autenticación
- La API key de Anthropic tiene costos asociados

## 💡 Consejos y Mejores Prácticas

### Para Mejores Resultados de IA:

1. **Perfiles Detallados**: Cuanto más detalle añadas a los perfiles, mejor será el menú generado
2. **Especifica Alergias**: Siempre marca claramente las alergias para evitar ingredientes peligrosos
3. **Sé Realista**: Indica tiempos de cocina realistas según tu disponibilidad
4. **Actualiza Regularmente**: Revisa y actualiza las preferencias de los niños (cambian con el tiempo)

### Para la Vista de TV:

1. **Full Screen**: Usa modo pantalla completa (F11 en la mayoría de navegadores)
2. **Evita Sleep**: Configura la TV para que no se apague automáticamente
3. **Bookmark**: Guarda la URL como favorito para acceso rápido

### Para Recetas:

1. **Fuentes Confiables**: Usa blogs y sitios de recetas conocidos
2. **Recetas Estructuradas**: Los sitios con Schema.org funcionan mejor
3. **Batch Extract**: Si tienes varias recetas de un sitio, usa extracción por lotes

## 🧪 Testing

El proyecto incluye un sistema completo de testing automático para prevenir errores:

### Ejecutar Tests

```bash
# Todos los tests
python run_tests.py

# Solo backend
pytest tests/ -v

# Solo frontend
node tests/test_frontend.js

# Con cobertura
pytest tests/ --cov=. --cov-report=html
```

### Cobertura Actual

- ✅ **Backend**: 18 tests (base de datos, API, generador de menús)
- ✅ **Frontend**: 7 tests (API mocks, utilidades)
- ✅ **Total**: 25 tests automáticos

Ver [TESTING.md](TESTING.md) para documentación completa del sistema de testing.

## 🚀 Próximas Mejoras Sugeridas

- [ ] Integración con calendarios (Google Calendar, iCal)
- [ ] Modo offline para la vista TV
- [ ] Exportar menús a PDF
- [ ] Sistema de favoritos para recetas
- [ ] Historial de menús anteriores
- [ ] Integración con listas de compra (Todoist, etc.)
- [ ] App móvil
- [ ] Notificaciones de recordatorio
- [ ] Modo "meal prep" para cocinar por lotes
- [ ] Análisis nutricional detallado

## 📄 Licencia

Este proyecto está diseñado para uso personal y familiar.

## 🤝 Contribuciones

Este es un proyecto personalizado, pero si encuentras bugs o tienes sugerencias:
1. Documenta el problema claramente
2. Proporciona ejemplos de reproducción
3. Sugiere soluciones si es posible

Ver [CONTRIBUTING.md](CONTRIBUTING.md) para la guía completa de contribución.

## 📚 Documentación Completa

### Documentación Principal

- **[DOCS_INDEX.md](DOCS_INDEX.md)** - Índice completo de toda la documentación
- **[API_DOCUMENTATION.md](API_DOCUMENTATION.md)** - Documentación completa de la API REST
- **[ARCHITECTURE.md](ARCHITECTURE.md)** - Arquitectura técnica del sistema
- **[DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md)** - Guía para desarrolladores
- **[DEPLOYMENT.md](DEPLOYMENT.md)** - Guía completa de deployment

### Guías de Inicio

- **[START_HERE.md](START_HERE.md)** - Guía de inicio rápido paso a paso
- **[GUIA_RAPIDA.md](GUIA_RAPIDA.md)** - Guía rápida en español
- **[INICIO_RAPIDO.md](INICIO_RAPIDO.md)** - Inicio rápido alternativo

### Testing y Contribución

- **[TESTING.md](TESTING.md)** - Guía completa del sistema de testing
- **[CONTRIBUTING.md](CONTRIBUTING.md)** - Cómo contribuir al proyecto
- **[PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md)** - Estructura detallada del proyecto

### Deployment

- **[DEPLOYMENT.md](DEPLOYMENT.md)** - Guía completa de deployment (Railway, Heroku, Docker, etc.)
- **[RAILWAY_DEPLOYMENT.md](RAILWAY_DEPLOYMENT.md)** - Guía específica de Railway

## 📞 Soporte

Para problemas con:
- **Anthropic API**: https://docs.anthropic.com/
- **Flask**: https://flask.palletsprojects.com/
- **Python**: https://docs.python.org/

## 🙏 Agradecimientos

- Anthropic por Claude AI
- La comunidad de Python y Flask
- Todos los blogs de cocina que comparten sus recetas

---

**¡Disfruta de tu planificación de menús automatizada! 🍽️✨**

Para empezar:
```bash
python init.py   # Inicializar
python app.py    # Ejecutar
```

Luego abre http://localhost:7000 en tu navegador.

---

## 🗺️ Navegación Rápida

- **Nuevo usuario?** → Empieza con [START_HERE.md](START_HERE.md)
- **Quieres usar la API?** → Lee [API_DOCUMENTATION.md](API_DOCUMENTATION.md)
- **Quieres desarrollar?** → Consulta [DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md)
- **Quieres desplegar?** → Sigue [DEPLOYMENT.md](DEPLOYMENT.md)
- **Quieres entender el sistema?** → Revisa [ARCHITECTURE.md](ARCHITECTURE.md)

Ver **[DOCS_INDEX.md](DOCS_INDEX.md)** para el índice completo de documentación.






================================================================================


ARCHIVO: DOCS_INDEX.md

# 📚 Índice de Documentación

Índice completo de toda la documentación disponible para k[AI]tchen.

## 🚀 Inicio Rápido

- **[README.md](README.md)** - Documentación principal del proyecto
- **[START_HERE.md](START_HERE.md)** - Guía de inicio rápido paso a paso
- **[GUIA_RAPIDA.md](GUIA_RAPIDA.md)** - Guía rápida en español
- **[INICIO_RAPIDO.md](INICIO_RAPIDO.md)** - Inicio rápido alternativo

## 📖 Documentación Técnica

### API y Endpoints

- **[API_DOCUMENTATION.md](API_DOCUMENTATION.md)** - Documentación completa de la API REST
  - Todos los endpoints disponibles
  - Ejemplos de requests y responses
  - Códigos de estado HTTP
  - Ejemplos de uso

### Arquitectura y Desarrollo

- **[ARCHITECTURE.md](ARCHITECTURE.md)** - Arquitectura técnica del sistema
  - Diagramas de componentes
  - Flujos de datos
  - Esquema de base de datos
  - Patrones de diseño

- **[DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md)** - Guía para desarrolladores
  - Configuración del entorno
  - Convenciones de código
  - Cómo escribir tests
  - Cómo añadir nuevas funcionalidades
  - Debugging

- **[PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md)** - Estructura del proyecto
  - Organización de archivos
  - Descripción de componentes
  - Estructura de directorios

### Deployment y Producción

- **[DEPLOYMENT.md](DEPLOYMENT.md)** - Guía completa de deployment
  - Deployment local
  - Deployment en Railway
  - Deployment en otros servicios (Heroku, DigitalOcean, AWS, Docker)
  - Configuración post-deployment
  - Troubleshooting

- **[RAILWAY_DEPLOYMENT.md](RAILWAY_DEPLOYMENT.md)** - Guía específica de Railway
- **[DEPLOY_INSTRUCTIONS.md](DEPLOY_INSTRUCTIONS.md)** - Instrucciones de deployment alternativas
- **[DEPLOY_RAILWAY.md](DEPLOY_RAILWAY.md)** - Guía Railway alternativa

### Testing

- **[TESTING.md](TESTING.md)** - Guía completa de testing
  - Cómo ejecutar tests
  - Cómo escribir nuevos tests
  - Cobertura de código
  - Estrategias de testing

### Contribución

- **[CONTRIBUTING.md](CONTRIBUTING.md)** - Guía de contribución
  - Cómo contribuir al proyecto
  - Proceso de pull requests
  - Estándares de código

## 🎯 Guías Específicas

### Configuración

- **[AÑADIR_PERFILES_MANUAL.md](AÑADIR_PERFILES_MANUAL.md)** - Cómo añadir perfiles manualmente
- **[AÑADIR_POSTGRESQL.md](AÑADIR_POSTGRESQL.md)** - Configuración de PostgreSQL
- **[VERIFICAR_POSTGRESQL.md](VERIFICAR_POSTGRESQL.md)** - Verificación de PostgreSQL
- **[VERIFICAR_RAILWAY.md](VERIFICAR_RAILWAY.md)** - Verificación de Railway

### Uso del Sistema

- **[GUIA_VISUAL.md](GUIA_VISUAL.md)** - Guía visual del sistema
- **[OBTENER_URL_EXTERNA.md](OBTENER_URL_EXTERNA.md)** - Cómo obtener URL externa
- **[SYNC_INSTRUCTIONS.md](SYNC_INSTRUCTIONS.md)** - Instrucciones de sincronización

### Inicio del Servidor

- **[INICIO_SERVIDOR.md](INICIO_SERVIDOR.md)** - Cómo iniciar el servidor
- **[INSTRUCCIONES_INICIO.md](INSTRUCCIONES_INICIO.md)** - Instrucciones de inicio alternativas

## 📋 Resúmenes y Referencias

- **[RESUMEN_PROYECTO.md](RESUMEN_PROYECTO.md)** - Resumen ejecutivo del proyecto
- **[BUILD_SUMMARY.md](BUILD_SUMMARY.md)** - Resumen de construcción
- **[CURSOR_WORKFLOW.md](CURSOR_WORKFLOW.md)** - Workflow con Cursor IDE

## 🗺️ Mapa de Navegación

### Para Nuevos Usuarios

1. Empieza con **[README.md](README.md)** para entender el proyecto
2. Sigue con **[START_HERE.md](START_HERE.md)** para configuración inicial
3. Usa **[GUIA_RAPIDA.md](GUIA_RAPIDA.md)** para empezar a usar el sistema

### Para Desarrolladores

1. Lee **[DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md)** para configuración del entorno
2. Revisa **[ARCHITECTURE.md](ARCHITECTURE.md)** para entender la arquitectura
3. Consulta **[API_DOCUMENTATION.md](API_DOCUMENTATION.md)** para trabajar con la API
4. Lee **[TESTING.md](TESTING.md)** para escribir tests

### Para Deployment

1. Lee **[DEPLOYMENT.md](DEPLOYMENT.md)** para guía completa
2. Si usas Railway, consulta **[RAILWAY_DEPLOYMENT.md](RAILWAY_DEPLOYMENT.md)**
3. Revisa la sección de troubleshooting en **[DEPLOYMENT.md](DEPLOYMENT.md)**

### Para Contribuir

1. Lee **[CONTRIBUTING.md](CONTRIBUTING.md)** para estándares
2. Revisa **[DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md)** para convenciones
3. Consulta **[PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md)** para organización

## 🔍 Búsqueda Rápida

### Por Tema

**Configuración Inicial**
- README.md
- START_HERE.md
- INICIO_RAPIDO.md

**API y Endpoints**
- API_DOCUMENTATION.md

**Arquitectura**
- ARCHITECTURE.md
- PROJECT_STRUCTURE.md

**Desarrollo**
- DEVELOPER_GUIDE.md
- CONTRIBUTING.md
- TESTING.md

**Deployment**
- DEPLOYMENT.md
- RAILWAY_DEPLOYMENT.md

**Uso del Sistema**
- GUIA_RAPIDA.md
- GUIA_VISUAL.md

## 📝 Notas

- La mayoría de la documentación está en español
- Los ejemplos de código están en Python y JavaScript
- Todas las rutas de archivos son relativas a la raíz del proyecto

## 🔄 Actualización

Este índice se actualiza cuando se añade nueva documentación. Si encuentras documentación faltante o desactualizada, por favor crea un issue o contribuye con mejoras.

---

**Última actualización**: Enero 2024






================================================================================


ARCHIVO: API_DOCUMENTATION.md

# 📡 Documentación de la API

Documentación completa de todos los endpoints disponibles en k[AI]tchen.

## 🔗 Base URL

- **Desarrollo**: `http://localhost:7000`
- **Producción**: `https://tu-dominio.com`

## 📋 Formato de Respuesta

Todas las respuestas siguen este formato:

```json
{
  "success": true|false,
  "data": {...},
  "error": "mensaje de error si success es false",
  "message": "mensaje opcional"
}
```

## 🔐 Autenticación

Actualmente, la API no requiere autenticación para uso local. En producción, se recomienda implementar autenticación mediante Clerk o similar.

---

## 👥 Perfiles de Adultos

### GET /api/adults

Obtiene todos los perfiles de adultos registrados.

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "nombre": "María",
      "edad": 38,
      "objetivo_alimentario": "Salud y bienestar",
      "estilo_alimentacion": "Mediterránea",
      "cocinas_favoritas": "Española, Italiana",
      "nivel_picante": "Medio",
      "ingredientes_favoritos": "Aceite de oliva, ajo, tomate",
      "ingredientes_no_gustan": "Pepino",
      "alergias": "",
      "intolerancias": "Lactosa leve",
      "restricciones_religiosas": "",
      "flexibilidad_comer": "Flexible",
      "preocupacion_principal": "Nutrición equilibrada",
      "tiempo_max_cocinar": 60,
      "nivel_cocina": "Intermedio",
      "tipo_desayuno": "Ligero",
      "le_gustan_snacks": true,
      "plato_favorito": "Paella",
      "created_at": "2024-01-15T10:30:00"
    }
  ],
  "count": 1
}
```

### POST /api/adults

Añade un nuevo perfil de adulto.

**Body (JSON)**:
```json
{
  "nombre": "María",
  "edad": 38,
  "objetivo_alimentario": "Salud y bienestar",
  "estilo_alimentacion": "Mediterránea",
  "cocinas_favoritas": "Española, Italiana",
  "nivel_picante": "Medio",
  "ingredientes_favoritos": "Aceite de oliva, ajo, tomate",
  "ingredientes_no_gustan": "Pepino",
  "alergias": "",
  "intolerancias": "Lactosa leve",
  "restricciones_religiosas": "",
  "flexibilidad_comer": "Flexible",
  "preocupacion_principal": "Nutrición equilibrada",
  "tiempo_max_cocinar": 60,
  "nivel_cocina": "Intermedio",
  "tipo_desayuno": "Ligero",
  "le_gustan_snacks": true,
  "plato_favorito": "Paella"
}
```

**Respuesta exitosa (201)**:
```json
{
  "success": true,
  "message": "Perfil de adulto añadido correctamente",
  "id": 1
}
```

**Errores posibles**:
- `400`: Datos inválidos o campos requeridos faltantes

### DELETE /api/adults/{id}

Elimina un perfil de adulto.

**Parámetros**:
- `id` (path): ID del adulto a eliminar

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "message": "Perfil eliminado correctamente"
}
```

**Errores posibles**:
- `404`: Perfil no encontrado

---

## 👶 Perfiles de Niños

### GET /api/children

Obtiene todos los perfiles de niños registrados.

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "nombre": "Emma",
      "edad": 12,
      "nivel_exigencia": "Media",
      "ingredientes_acepta": "Pasta, pollo, patatas",
      "ingredientes_rechaza": "Pescado azul, brócoli",
      "texturas_no_gusta": "Muy cremoso",
      "alergias": "",
      "intolerancias": "",
      "preferencias_comida": "Platos simples",
      "comida_favorita": "Espaguetis con tomate",
      "comida_rechaza": "Pescado",
      "nivel_actividad": "Alta",
      "apetito": "Normal",
      "created_at": "2024-01-15T10:30:00"
    }
  ],
  "count": 1
}
```

### POST /api/children

Añade un nuevo perfil de niño.

**Body (JSON)**:
```json
{
  "nombre": "Emma",
  "edad": 12,
  "nivel_exigencia": "Media",
  "ingredientes_acepta": "Pasta, pollo, patatas",
  "ingredientes_rechaza": "Pescado azul, brócoli",
  "texturas_no_gusta": "Muy cremoso",
  "alergias": "",
  "intolerancias": "",
  "preferencias_comida": "Platos simples",
  "comida_favorita": "Espaguetis con tomate",
  "comida_rechaza": "Pescado",
  "nivel_actividad": "Alta",
  "apetito": "Normal"
}
```

**Respuesta exitosa (201)**:
```json
{
  "success": true,
  "message": "Perfil de niño añadido correctamente",
  "id": 1
}
```

### DELETE /api/children/{id}

Elimina un perfil de niño.

**Parámetros**:
- `id` (path): ID del niño a eliminar

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "message": "Perfil eliminado correctamente"
}
```

---

## 🍳 Recetas

### GET /api/recipes

Obtiene todas las recetas almacenadas.

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "title": "Paella Valenciana",
      "url": "https://ejemplo.com/paella",
      "ingredients": ["arroz", "pollo", "azafrán"],
      "instructions": "1. Calentar aceite...",
      "prep_time": 30,
      "cook_time": 45,
      "servings": 4,
      "cuisine_type": "Española",
      "meal_type": "Comida",
      "difficulty": "Media",
      "image_url": "https://ejemplo.com/imagen.jpg",
      "created_at": "2024-01-15T10:30:00"
    }
  ],
  "count": 1
}
```

### POST /api/recipes/extract

Extrae una receta desde una URL.

**Body (JSON)**:
```json
{
  "url": "https://ejemplo.com/receta"
}
```

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "message": "Receta extraída y guardada correctamente",
  "data": {
    "id": 1,
    "title": "Paella Valenciana",
    "url": "https://ejemplo.com/receta",
    "ingredients": ["arroz", "pollo", "azafrán"],
    "instructions": "1. Calentar aceite...",
    "prep_time": 30,
    "cook_time": 45,
    "servings": 4
  }
}
```

**Errores posibles**:
- `400`: URL inválida o no se pudo extraer la receta
- `500`: Error al guardar en base de datos

### POST /api/recipes/batch

Extrae múltiples recetas desde URLs.

**Body (JSON)**:
```json
{
  "urls": [
    "https://ejemplo.com/receta1",
    "https://ejemplo.com/receta2",
    "https://ejemplo.com/receta3"
  ]
}
```

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "message": "2/3 recetas extraídas correctamente",
  "data": [
    {
      "id": 1,
      "title": "Receta 1",
      "success": true
    },
    {
      "error": "No se pudo extraer la receta",
      "url": "https://ejemplo.com/receta2",
      "success": false
    },
    {
      "id": 2,
      "title": "Receta 3",
      "success": true
    }
  ]
}
```

### GET /api/recipes/search

Busca una receta por título (case-insensitive).

**Query Parameters**:
- `title` (required): Título de la receta a buscar

**Ejemplo**: `GET /api/recipes/search?title=paella`

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "title": "Paella Valenciana",
    "url": "https://ejemplo.com/paella",
    "instructions": "1. Calentar aceite..."
  }
}
```

**Si no se encuentra**:
```json
{
  "success": false,
  "data": null
}
```

### DELETE /api/recipes/{id}

Elimina una receta.

**Parámetros**:
- `id` (path): ID de la receta a eliminar

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "message": "Receta eliminada correctamente"
}
```

---

## 📅 Menús

### POST /api/menu/generate

Genera un menú semanal usando IA (Claude).

**Body (JSON)**:
```json
{
  "preferences": {
    "include_weekend": true,
    "include_breakfast": true,
    "include_lunch": true,
    "include_dinner": true,
    "excluded_days": []
  },
  "day_settings": {
    "lunes": {
      "meals": ["desayuno", "comida", "cena"],
      "no_cooking": false
    },
    "martes": {
      "meals": ["desayuno", "comida"],
      "no_cooking": false
    }
  },
  "week_start_date": "2024-01-15"
}
```

**Parámetros opcionales**:
- `preferences`: Preferencias adicionales del menú
- `day_settings`: Configuración específica por día
- `week_start_date`: Fecha de inicio de semana (YYYY-MM-DD). Si no se proporciona, usa la semana actual.

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "message": "Menú generado correctamente",
  "menu": {
    "menu_adultos": {
      "dias": {
        "lunes": {
          "desayuno": "Tostadas con tomate y aceite",
          "comida": "Paella de pollo y verduras",
          "merienda": "Fruta",
          "cena": "Ensalada mediterránea"
        }
      }
    },
    "menu_ninos": {
      "dias": {
        "lunes": {
          "desayuno": "Cereales con leche",
          "comida": "Espaguetis con tomate",
          "merienda": "Yogur",
          "cena": "Pollo a la plancha con patatas"
        }
      }
    },
    "lista_compra": ["arroz", "pollo", "tomate", "aceite"],
    "consejos": "Preparar el pollo con antelación..."
  },
  "menu_id": 1,
  "week_start": "2024-01-15",
  "generated_at": "2024-01-15T10:30:00"
}
```

**Errores posibles**:
- `400`: No hay perfiles familiares configurados
- `400`: API key de Anthropic no configurada
- `400`: Error en la generación del menú

### GET /api/menu/latest

Obtiene el menú más reciente generado.

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "week_start_date": "2024-01-15",
    "menu_data": {
      "menu_adultos": {...},
      "menu_ninos": {...}
    },
    "metadata": {
      "generated_at": "2024-01-15T10:30:00"
    },
    "created_at": "2024-01-15T10:30:00"
  }
}
```

**Errores posibles**:
- `404`: No hay menús disponibles

### GET /api/menu/week/{week_start}

Obtiene el menú para una semana específica.

**Parámetros**:
- `week_start` (path): Fecha de inicio de semana en formato YYYY-MM-DD

**Ejemplo**: `GET /api/menu/week/2024-01-15`

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "week_start_date": "2024-01-15",
    "menu_data": {...}
  },
  "week_start": "2024-01-15"
}
```

**Errores posibles**:
- `404`: No hay menú disponible para esa semana

### GET /api/menu/current-week

Obtiene el menú de la semana actual (lunes de la semana actual).

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "week_start_date": "2024-01-15",
    "menu_data": {...}
  },
  "week_start": "2024-01-15",
  "is_fallback": false
}
```

**Nota**: Si no hay menú para la semana actual, devuelve el menú más reciente con `is_fallback: true`.

### GET /api/menu/next-week

Obtiene el menú de la próxima semana.

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "data": {
    "id": 2,
    "week_start_date": "2024-01-22",
    "menu_data": {...}
  },
  "week_start": "2024-01-22"
}
```

### GET /api/menu/all

Obtiene todos los menús disponibles.

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "week_start_date": "2024-01-15",
      "menu_data": {...}
    },
    {
      "id": 2,
      "week_start_date": "2024-01-22",
      "menu_data": {...}
    }
  ],
  "count": 2
}
```

### POST /api/menu/rate-day

Califica un día específico del menú (adultos o niños).

**Body (JSON)**:
```json
{
  "menu_id": 1,
  "week_start_date": "2024-01-15",
  "day_name": "lunes",
  "menu_type": "adultos",
  "rating": 4
}
```

**Parámetros**:
- `menu_id`: ID del menú
- `week_start_date`: Fecha de inicio de semana (YYYY-MM-DD)
- `day_name`: Nombre del día (lunes, martes, etc.)
- `menu_type`: Tipo de menú (`"adultos"` o `"ninos"`)
- `rating`: Calificación entre 1 y 5

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "message": "Rating guardado correctamente"
}
```

### GET /api/menu/get-day-rating

Obtiene la calificación de un día específico.

**Query Parameters**:
- `menu_id` (required): ID del menú
- `day_name` (required): Nombre del día
- `menu_type` (required): Tipo de menú (`"adultos"` o `"ninos"`)

**Ejemplo**: `GET /api/menu/get-day-rating?menu_id=1&day_name=lunes&menu_type=adultos`

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "data": {
    "rating": 4
  }
}
```

### POST /api/menu/regenerate-day

Regenera el menú de un día específico.

**Body (JSON)**:
```json
{
  "menu_id": 1,
  "week_start_date": "2024-01-15",
  "day_name": "lunes",
  "menu_type": "adultos"
}
```

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "message": "Menú regenerado para lunes (adultos)",
  "data": {
    "desayuno": "Nuevo desayuno",
    "comida": "Nueva comida",
    "merienda": "Nueva merienda",
    "cena": "Nueva cena"
  }
}
```

---

## ⚙️ Configuración

### GET /api/settings

Obtiene la configuración actual del sistema.

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "data": {
    "has_api_key": true,
    "api_key_preview": "sk-ant-api03-...",
    "port": 7000,
    "mode": "development",
    "menu_preferences": {
      "include_weekend": true,
      "include_breakfast": true,
      "include_lunch": true,
      "include_dinner": true,
      "excluded_days": []
    }
  }
}
```

### POST /api/settings

Guarda la configuración del sistema.

**Body (JSON)**:
```json
{
  "anthropic_api_key": "sk-ant-api03-...",
  "menu_preferences": {
    "include_weekend": true,
    "include_breakfast": true,
    "include_lunch": true,
    "include_dinner": true,
    "excluded_days": []
  }
}
```

**Nota**: Puedes enviar solo `anthropic_api_key` o solo `menu_preferences`, o ambos.

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "message": "Configuración guardada correctamente. El servidor necesita reiniciarse para aplicar cambios de API key."
}
```

### POST /api/settings/test

Prueba si una API key es válida.

**Body (JSON)**:
```json
{
  "anthropic_api_key": "sk-ant-api03-..."
}
```

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "message": "API key válida. El formato es correcto."
}
```

---

## 👨‍👩‍👧‍👦 Familia

### GET /api/family/summary

Obtiene un resumen de todos los miembros de la familia.

**Respuesta exitosa (200)**:
```json
{
  "success": true,
  "data": {
    "adults": [
      {
        "id": 1,
        "nombre": "María",
        "edad": 38
      }
    ],
    "children": [
      {
        "id": 1,
        "nombre": "Emma",
        "edad": 12
      }
    ],
    "total_members": 2
  }
}
```

---

## 🏥 Health Check

### GET /health

Endpoint de verificación de salud del servidor.

**Respuesta exitosa (200)**:
```json
{
  "status": "ok",
  "timestamp": "2024-01-15T10:30:00"
}
```

---

## 🌐 Rutas Web (No API)

### GET /

Interfaz de administración principal.

### GET /tv

Vista optimizada para TV de cocina.

### GET /menu/visualizer

Visualizador de menús.

### GET /recipe/view

Visualización de receta individual.

**Query Parameters**:
- `title` (required): Título de la receta

**Ejemplo**: `GET /recipe/view?title=Paella%20Valenciana`

---

## ⚠️ Códigos de Estado HTTP

- `200`: Éxito
- `201`: Creado exitosamente
- `400`: Solicitud inválida (datos faltantes o incorrectos)
- `403`: Prohibido (solo para endpoints locales)
- `404`: Recurso no encontrado
- `500`: Error interno del servidor

---

## 🔒 Seguridad

### Endpoints Locales

Los siguientes endpoints solo están disponibles desde localhost:
- `/api/temp/get-api-key`
- `/api/temp/save-api-key-to-env`
- `/recover-api-key`

### Variables de Entorno

Asegúrate de configurar las siguientes variables en producción:
- `ANTHROPIC_API_KEY`: API key de Anthropic
- `SECRET_KEY`: Clave secreta para sesiones Flask
- `DATABASE_URL`: URL de la base de datos (PostgreSQL en producción)
- `CORS_ORIGINS`: Orígenes permitidos para CORS (separados por comas)

---

## 📝 Notas Adicionales

### Formato de Fechas

Todas las fechas se manejan en formato ISO 8601: `YYYY-MM-DD` o `YYYY-MM-DDTHH:MM:SS`.

### Semanas

Las semanas siempre comienzan en lunes. El sistema calcula automáticamente el lunes de la semana actual si no se proporciona una fecha específica.

### Timeouts

- Extracción de recetas: 10 segundos
- Generación de menús: 5 minutos (300 segundos)

### Límites

- No hay límites específicos en el número de perfiles o recetas
- Se recomienda mantener menos de 1000 recetas para mejor rendimiento
- Los menús históricos se mantienen indefinidamente

---

## 🧪 Ejemplos de Uso

### Ejemplo completo: Generar menú semanal

```bash
# 1. Obtener perfiles familiares
curl http://localhost:7000/api/adults
curl http://localhost:7000/api/children

# 2. (Opcional) Añadir recetas
curl -X POST http://localhost:7000/api/recipes/extract \
  -H "Content-Type: application/json" \
  -d '{"url": "https://ejemplo.com/receta"}'

# 3. Generar menú
curl -X POST http://localhost:7000/api/menu/generate \
  -H "Content-Type: application/json" \
  -d '{
    "preferences": {
      "include_weekend": true,
      "include_breakfast": true,
      "include_lunch": true,
      "include_dinner": true
    }
  }'

# 4. Obtener menú generado
curl http://localhost:7000/api/menu/current-week
```

### Ejemplo: Calificar un día

```bash
curl -X POST http://localhost:7000/api/menu/rate-day \
  -H "Content-Type: application/json" \
  -d '{
    "menu_id": 1,
    "week_start_date": "2024-01-15",
    "day_name": "lunes",
    "menu_type": "adultos",
    "rating": 5
  }'
```

---

## 📚 Referencias

- [Documentación de Flask](https://flask.palletsprojects.com/)
- [Documentación de Anthropic Claude](https://docs.anthropic.com/)
- [Documentación de Railway](https://docs.railway.app/)






================================================================================


ARCHIVO: ARCHITECTURE.md

# 🏗️ Arquitectura del Sistema

Documentación técnica detallada de la arquitectura de k[AI]tchen.

## 📐 Visión General

k[AI]tchen es una aplicación web full-stack construida con Flask (backend) y JavaScript vanilla (frontend), diseñada para generar menús semanales personalizados usando inteligencia artificial.

```
┌─────────────────────────────────────────────────────────────┐
│                        CLIENTE                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Navegador   │  │   TV/Tablet  │  │   Móvil      │      │
│  │ (Admin UI)   │  │  (TV View)   │  │  (Mobile)    │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
└─────────┼─────────────────┼─────────────────┼──────────────┘
          │                 │                 │
          └─────────────────┼─────────────────┘
                            │
          ┌─────────────────▼─────────────────┐
          │      FLASK SERVER (app.py)         │
          │  ┌──────────────────────────────┐ │
          │  │   REST API Endpoints         │ │
          │  │   - /api/adults              │ │
          │  │   - /api/children            │ │
          │  │   - /api/recipes             │ │
          │  │   - /api/menu/generate       │ │
          │  └──────────────────────────────┘ │
          └─────────────────┬─────────────────┘
                            │
          ┌─────────────────┼─────────────────┐
          │                 │                 │
    ┌─────▼─────┐   ┌──────▼──────┐   ┌─────▼─────┐
    │ Database  │   │   Claude    │   │  Recipe   │
    │  Layer    │   │     AI      │   │ Extractor │
    │(database.py)│   │(menu_gen.py)│   │(extractor)│
    └─────┬─────┘   └──────┬──────┘   └─────┬─────┘
          │                 │                 │
    ┌─────▼─────────────────▼─────────────────▼─────┐
    │           SQLite (Local) / PostgreSQL          │
    │              (Production - Railway)             │
    └────────────────────────────────────────────────┘
```

## 🔧 Componentes Principales

### 1. Backend (Flask)

#### `app.py` - Servidor Principal

**Responsabilidades**:
- Configuración de Flask y CORS
- Definición de rutas web y API
- Manejo de errores HTTP
- Inicialización de componentes

**Estructura**:
```python
app.py
├── Configuración
│   ├── Flask app initialization
│   ├── CORS configuration
│   └── Error handlers
├── Rutas Web
│   ├── / (admin interface)
│   ├── /tv (TV display)
│   └── /menu/visualizer
├── API Endpoints
│   ├── /api/adults (CRUD)
│   ├── /api/children (CRUD)
│   ├── /api/recipes (CRUD + extract)
│   ├── /api/menu/* (generate, get, rate)
│   └── /api/settings
└── Inicialización
    └── Server startup
```

**Características clave**:
- Lazy loading del `MenuGenerator` (solo se inicializa cuando se necesita)
- Manejo de errores JSON para rutas API
- Soporte para múltiples orígenes CORS
- Variables de entorno para configuración

#### `database.py` - Capa de Datos

**Responsabilidades**:
- Abstracción de base de datos (SQLite/PostgreSQL)
- CRUD operations para todas las entidades
- Gestión de conexiones y pools
- Migraciones automáticas de esquema

**Arquitectura**:
```python
Database
├── __init__()
│   ├── Detect database type (SQLite/PostgreSQL)
│   ├── Initialize connection pool
│   └── Create tables if not exist
├── Adults Management
│   ├── add_adult()
│   ├── get_all_adults()
│   └── delete_adult()
├── Children Management
│   ├── add_child()
│   ├── get_all_children()
│   └── delete_child()
├── Recipes Management
│   ├── add_recipe()
│   ├── get_all_recipes()
│   ├── delete_recipe()
│   └── _find_recipe_by_title()
├── Menus Management
│   ├── save_weekly_menu()
│   ├── get_latest_menu()
│   ├── get_menu_by_week_start()
│   ├── get_all_menus()
│   └── extract_and_save_recipes_from_menu()
└── Ratings & Preferences
    ├── rate_menu_day()
    ├── get_menu_day_rating()
    ├── get_all_menu_ratings()
    ├── save_menu_preferences()
    └── get_menu_preferences()
```

**Patrón de Diseño**: Repository Pattern

**Ventajas**:
- Cambio fácil entre SQLite y PostgreSQL
- Código de negocio desacoplado de la base de datos
- Fácil testing con mocks

#### `menu_generator.py` - Generador de Menús con IA

**Responsabilidades**:
- Comunicación con API de Anthropic Claude
- Construcción de prompts personalizados
- Parsing de respuestas JSON
- Manejo de errores y timeouts

**Flujo de Generación**:
```
1. Recibir perfiles familiares
   ↓
2. Construir prompt detallado
   ├── Preferencias de adultos
   ├── Preferencias de niños
   ├── Recetas disponibles
   ├── Configuración de días
   └── Ratings históricos
   ↓
3. Llamar a Claude API
   ├── Timeout: 5 minutos
   ├── Model: claude-sonnet-4-20250514
   └── Max tokens: 8000
   ↓
4. Parsear respuesta JSON
   ├── Validar estructura
   ├── Reparar JSON si es necesario
   └── Extraer datos del menú
   ↓
5. Retornar menú estructurado
```

**Características**:
- Prompts dinámicos basados en perfiles
- Aprendizaje de ratings históricos
- Manejo robusto de errores JSON
- Soporte para regeneración de días individuales

#### `recipe_extractor.py` - Extractor de Recetas

**Responsabilidades**:
- Web scraping de URLs de recetas
- Extracción de datos estructurados
- Manejo de múltiples formatos
- Soporte para Pinterest y otros sitios

**Estrategia de Extracción**:
```
1. Detectar tipo de URL
   ├── Pinterest → Seguir redirects
   └── Directa → Continuar
   ↓
2. Intentar extracción estructurada
   ├── JSON-LD (Schema.org)
   ├── Microdata
   └── Open Graph
   ↓
3. Si falla, extracción manual
   ├── BeautifulSoup parsing
   ├── Buscar patrones comunes
   └── Trafilatura para texto
   ↓
4. Normalizar datos
   ├── Limpiar ingredientes
   ├── Formatear instrucciones
   └── Extraer metadatos
   ↓
5. Retornar datos estructurados
```

**Características**:
- Soporte para múltiples sitios web
- Manejo de errores robusto
- Extracción por lotes
- Cache de resultados (futuro)

### 2. Frontend (Vanilla JavaScript)

#### `static/js/app.js` - Lógica del Cliente

**Estructura**:
```javascript
app.js
├── State Management
│   ├── Global state object
│   └── State update functions
├── API Client
│   ├── fetchAPI() - Generic fetch wrapper
│   ├── CRUD operations
│   └── Error handling
├── UI Components
│   ├── Profile forms
│   ├── Recipe extractor
│   ├── Menu display
│   └── Settings panel
├── Event Handlers
│   ├── Form submissions
│   ├── Button clicks
│   └── Tab navigation
└── Utilities
    ├── Date formatting
    ├── Data validation
    └── DOM manipulation
```

**Patrón**: MVC (Model-View-Controller) simplificado

**Características**:
- Sin dependencias externas (vanilla JS)
- Manejo de estado centralizado
- Actualización reactiva de UI
- Manejo de errores user-friendly

#### Templates HTML

**`templates/index.html`** - Interfaz de Administración
- 4 pestañas principales: Familia, Recetas, Menú, Vista TV
- Formularios dinámicos para perfiles
- Visualización de datos en tablas
- Configuración de preferencias

**`templates/tv_display.html`** - Vista para TV
- Diseño optimizado para pantallas grandes
- Auto-refresh cada 5 minutos
- Navegación por días
- Estilos grandes y legibles

**`templates/menu_visualizer.html`** - Visualizador de Menús
- Vista detallada de menús
- Navegación semanal
- Ratings y feedback

## 🗄️ Base de Datos

### Esquema de Datos

#### Tabla: `adults`
```sql
CREATE TABLE adults (
    id INTEGER PRIMARY KEY,
    nombre TEXT NOT NULL,
    edad INTEGER,
    objetivo_alimentario TEXT,
    estilo_alimentacion TEXT,
    cocinas_favoritas TEXT,
    nivel_picante TEXT,
    ingredientes_favoritos TEXT,
    ingredientes_no_gustan TEXT,
    alergias TEXT,
    intolerancias TEXT,
    restricciones_religiosas TEXT,
    flexibilidad_comer TEXT,
    preocupacion_principal TEXT,
    tiempo_max_cocinar INTEGER,
    nivel_cocina TEXT,
    tipo_desayuno TEXT,
    le_gustan_snacks BOOLEAN,
    plato_favorito TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Tabla: `children`
```sql
CREATE TABLE children (
    id INTEGER PRIMARY KEY,
    nombre TEXT NOT NULL,
    edad INTEGER,
    nivel_exigencia TEXT,
    ingredientes_acepta TEXT,
    ingredientes_rechaza TEXT,
    texturas_no_gusta TEXT,
    alergias TEXT,
    intolerancias TEXT,
    preferencias_comida TEXT,
    comida_favorita TEXT,
    comida_rechaza TEXT,
    nivel_actividad TEXT,
    apetito TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Tabla: `recipes`
```sql
CREATE TABLE recipes (
    id INTEGER PRIMARY KEY,
    title TEXT NOT NULL,
    url TEXT,
    ingredients TEXT,  -- JSON array
    instructions TEXT,
    prep_time INTEGER,
    cook_time INTEGER,
    servings INTEGER,
    cuisine_type TEXT,
    meal_type TEXT,
    difficulty TEXT,
    image_url TEXT,
    extracted_data TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Tabla: `weekly_menus`
```sql
CREATE TABLE weekly_menus (
    id INTEGER PRIMARY KEY,
    week_start_date DATE NOT NULL UNIQUE,
    menu_data TEXT NOT NULL,  -- JSON
    metadata TEXT,  -- JSON
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Tabla: `menu_ratings`
```sql
CREATE TABLE menu_ratings (
    id INTEGER PRIMARY KEY,
    menu_id INTEGER,
    week_start_date DATE,
    day_name TEXT,
    menu_type TEXT,  -- 'adultos' or 'ninos'
    rating INTEGER CHECK(rating >= 1 AND rating <= 5),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (menu_id) REFERENCES weekly_menus(id)
);
```

#### Tabla: `menu_preferences`
```sql
CREATE TABLE menu_preferences (
    id INTEGER PRIMARY KEY,
    preferences TEXT NOT NULL,  -- JSON
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Relaciones

```
weekly_menus (1) ──< (N) menu_ratings
```

## 🔄 Flujos de Datos

### Flujo 1: Generación de Menú

```
Usuario → Frontend → POST /api/menu/generate
                        ↓
                    app.py (endpoint handler)
                        ↓
                    Database.get_all_adults()
                    Database.get_all_children()
                    Database.get_all_recipes()
                        ↓
                    MenuGenerator.generate_weekly_menu()
                        ↓
                    Claude API (HTTP Request)
                        ↓
                    Parse JSON Response
                        ↓
                    Database.save_weekly_menu()
                        ↓
                    Return JSON to Frontend
                        ↓
                    Update UI
```

### Flujo 2: Extracción de Receta

```
Usuario → Frontend → POST /api/recipes/extract
                        ↓
                    app.py (endpoint handler)
                        ↓
                    RecipeExtractor.extract_from_url()
                        ↓
                    HTTP GET to recipe URL
                        ↓
                    BeautifulSoup + Trafilatura parsing
                        ↓
                    Database.add_recipe()
                        ↓
                    Return JSON to Frontend
                        ↓
                    Display recipe in UI
```

### Flujo 3: Visualización en TV

```
TV Browser → GET /tv
                ↓
            Render tv_display.html
                ↓
            JavaScript loads menu
                ↓
            GET /api/menu/current-week
                ↓
            Display menu in large format
                ↓
            Auto-refresh every 5 minutes
```

## 🔐 Seguridad

### Variables de Entorno

Todas las configuraciones sensibles están en `.env`:
- `ANTHROPIC_API_KEY`: API key de Anthropic (nunca commitear)
- `SECRET_KEY`: Clave secreta para sesiones Flask
- `DATABASE_URL`: URL de base de datos (con credenciales)
- `CORS_ORIGINS`: Orígenes permitidos para CORS

### Validación de Datos

- Validación en backend de todos los inputs
- Sanitización de URLs antes de scraping
- Validación de tipos de datos
- Límites en tamaños de datos

### Endpoints Protegidos

Algunos endpoints solo están disponibles desde localhost:
- `/api/temp/get-api-key`
- `/api/temp/save-api-key-to-env`
- `/recover-api-key`

## 🚀 Deployment

### Desarrollo Local

```bash
python app.py
# Servidor en http://localhost:7000
```

### Producción (Railway)

```
Railway Platform
├── Build: pip install -r requirements.txt
├── Start: gunicorn app:app
├── Database: PostgreSQL (proporcionado por Railway)
└── Environment: Variables desde Railway dashboard
```

**Configuración**:
- `FLASK_ENV=production`
- `PORT`: Automático desde Railway
- `DATABASE_URL`: PostgreSQL de Railway
- Workers: 2 (configurado en Procfile)

## 📊 Escalabilidad

### Limitaciones Actuales

- **Base de datos**: SQLite en desarrollo (no escalable)
- **Servidor**: Single-threaded Flask en desarrollo
- **API**: Sin rate limiting
- **Cache**: Sin sistema de cache

### Mejoras Futuras

1. **Base de datos**: Ya soporta PostgreSQL (usar en producción)
2. **Cache**: Implementar Redis para:
   - Cache de recetas extraídas
   - Cache de menús generados
   - Session storage
3. **Rate Limiting**: Implementar límites de API
4. **CDN**: Para assets estáticos
5. **Queue System**: Para procesamiento asíncrono de:
   - Extracción de recetas
   - Generación de menús

## 🧪 Testing

### Estructura de Tests

```
tests/
├── test_database.py      # Tests de base de datos
├── test_api.py           # Tests de endpoints API
├── test_menu_generator.py # Tests de generación de menús
└── test_recipe_extractor.py # Tests de extracción
```

### Cobertura

- Backend: 18 tests
- Frontend: 7 tests (mocks)
- Total: 25 tests automáticos

## 📈 Monitoreo

### Logs

El sistema genera logs en:
- Console (desarrollo)
- Railway logs (producción)

### Métricas Recomendadas

- Tiempo de respuesta de API
- Tasa de éxito de extracción de recetas
- Tiempo de generación de menús
- Uso de memoria y CPU
- Errores de base de datos

## 🔄 Mantenimiento

### Tareas Regulares

1. **Backup de base de datos**: Diario (en producción)
2. **Limpieza de menús antiguos**: Mensual (opcional)
3. **Actualización de dependencias**: Mensual
4. **Revisión de logs**: Semanal

### Migraciones

Las migraciones de esquema se hacen automáticamente en `database.py` usando `CREATE TABLE IF NOT EXISTS`. Para cambios de esquema:

1. Modificar `init_database()` en `database.py`
2. Añadir lógica de migración si es necesario
3. Probar en desarrollo antes de producción

---

## 📚 Referencias

- [Flask Documentation](https://flask.palletsprojects.com/)
- [Anthropic Claude API](https://docs.anthropic.com/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Railway Documentation](https://docs.railway.app/)






================================================================================


ARCHIVO: DEVELOPER_GUIDE.md

# 👨‍💻 Guía para Desarrolladores

Guía completa para desarrolladores que quieran contribuir o extender k[AI]tchen.

## 🚀 Configuración del Entorno de Desarrollo

### Requisitos Previos

- Python 3.8 o superior
- pip (gestor de paquetes de Python)
- Git (control de versiones)
- Editor de código (VS Code, PyCharm, etc.)

### Instalación

```bash
# 1. Clonar el repositorio
git clone <repository-url>
cd JAXOKITCHEN

# 2. Crear entorno virtual (recomendado)
python -m venv venv

# 3. Activar entorno virtual
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# 4. Instalar dependencias
pip install -r requirements.txt

# 5. Configurar variables de entorno
cp .env.example .env
# Editar .env y añadir tu ANTHROPIC_API_KEY

# 6. Inicializar base de datos
python init.py

# 7. Ejecutar servidor de desarrollo
python app.py
```

### Estructura del Proyecto

```
JAXOKITCHEN/
├── app.py                 # Servidor Flask principal
├── database.py            # Capa de acceso a datos
├── menu_generator.py      # Generador de menús con IA
├── recipe_extractor.py    # Extractor de recetas
├── init.py                # Script de inicialización
├── requirements.txt        # Dependencias Python
├── .env                   # Variables de entorno (no commitear)
├── .env.example           # Ejemplo de variables de entorno
├── Procfile               # Configuración Railway
├── railway.toml           # Configuración Railway
├── pytest.ini             # Configuración pytest
├── templates/             # Plantillas HTML
│   ├── index.html
│   ├── tv_display.html
│   ├── menu_visualizer.html
│   └── recipe_view.html
├── static/                # Archivos estáticos
│   ├── css/
│   └── js/
│       └── app.js
├── tests/                 # Tests automatizados
│   ├── test_database.py
│   ├── test_api.py
│   ├── test_menu_generator.py
│   └── test_recipe_extractor.py
└── docs/                  # Documentación adicional
    ├── API_DOCUMENTATION.md
    ├── ARCHITECTURE.md
    └── DEVELOPER_GUIDE.md
```

## 📝 Convenciones de Código

### Python

#### Estilo de Código

- Seguir **PEP 8** (guía de estilo de Python)
- Usar **type hints** en todas las funciones
- Documentar funciones con **docstrings** (formato Google)
- Máximo 100 caracteres por línea
- Usar **f-strings** en lugar de `.format()` o `%`

#### Ejemplo de Función Bien Documentada

```python
def add_adult(self, profile: Dict[str, Any]) -> int:
    """
    Añade un nuevo perfil de adulto a la base de datos.
    
    Args:
        profile: Diccionario con los datos del adulto. Debe incluir
                 al menos 'nombre'. Otros campos opcionales incluyen
                 'edad', 'objetivo_alimentario', etc.
    
    Returns:
        ID del adulto recién creado.
    
    Raises:
        ValueError: Si el nombre está vacío o es None.
        sqlite3.Error: Si hay un error de base de datos.
    """
    if not profile.get('nombre'):
        raise ValueError("El nombre es requerido")
    
    # ... código de implementación ...
    return adult_id
```

#### Nombres de Variables

- **snake_case** para variables y funciones
- **PascalCase** para clases
- **UPPER_CASE** para constantes
- Nombres descriptivos y en español para variables de dominio

#### Manejo de Errores

```python
# ✅ BIEN: Manejo específico de errores
try:
    result = db.add_recipe(recipe_data)
except sqlite3.IntegrityError as e:
    logger.error(f"Error de integridad: {e}")
    return jsonify({'success': False, 'error': 'Receta duplicada'}), 400
except Exception as e:
    logger.error(f"Error inesperado: {e}")
    return jsonify({'success': False, 'error': 'Error interno'}), 500

# ❌ MAL: Captura genérica sin logging
try:
    result = db.add_recipe(recipe_data)
except:
    return jsonify({'error': 'Error'}), 500
```

### JavaScript

#### Estilo de Código

- Usar **ES6+** (arrow functions, const/let, template literals)
- Preferir **const** sobre **let**, evitar **var**
- Usar **async/await** en lugar de `.then()`
- Máximo 100 caracteres por línea
- Comentarios en español para lógica de negocio

#### Ejemplo de Función Bien Escrita

```javascript
/**
 * Obtiene todos los perfiles de adultos desde la API
 * @returns {Promise<Array>} Array de perfiles de adultos
 */
async function fetchAdults() {
    try {
        const response = await fetchAPI('/api/adults');
        if (response.success) {
            return response.data;
        } else {
            console.error('Error al obtener adultos:', response.error);
            return [];
        }
    } catch (error) {
        console.error('Error de red:', error);
        showError('No se pudo conectar con el servidor');
        return [];
    }
}
```

## 🧪 Testing

### Ejecutar Tests

```bash
# Todos los tests
python run_tests.py

# Tests específicos
pytest tests/test_database.py -v

# Con cobertura
pytest tests/ --cov=. --cov-report=html

# Tests con output detallado
pytest tests/ -v -s
```

### Escribir Nuevos Tests

#### Estructura de un Test

```python
import pytest
from database import Database

def test_add_adult_success():
    """Test que añade un adulto correctamente"""
    db = Database()
    
    profile = {
        'nombre': 'Test User',
        'edad': 30,
        'objetivo_alimentario': 'Salud'
    }
    
    adult_id = db.add_adult(profile)
    
    assert adult_id is not None
    assert isinstance(adult_id, int)
    
    # Verificar que se guardó correctamente
    adults = db.get_all_adults()
    assert len(adults) > 0
    assert any(a['nombre'] == 'Test User' for a in adults)
```

#### Fixtures de pytest

```python
import pytest
from database import Database

@pytest.fixture
def db():
    """Fixture que proporciona una instancia de Database"""
    db = Database()
    # Setup: crear tablas si no existen
    db.init_database()
    yield db
    # Teardown: limpiar después del test
    # (opcional, dependiendo de si usas DB en memoria)

@pytest.fixture
def sample_adult():
    """Fixture con datos de ejemplo de adulto"""
    return {
        'nombre': 'María',
        'edad': 38,
        'objetivo_alimentario': 'Salud'
    }

def test_add_adult(db, sample_adult):
    """Test usando fixtures"""
    adult_id = db.add_adult(sample_adult)
    assert adult_id is not None
```

### Mocking de APIs Externas

```python
from unittest.mock import patch, MagicMock
from menu_generator import MenuGenerator

@patch('menu_generator.anthropic.Anthropic')
def test_generate_menu_success(mock_anthropic):
    """Test de generación de menú con mock de API"""
    # Configurar mock
    mock_client = MagicMock()
    mock_anthropic.return_value = mock_client
    
    mock_response = MagicMock()
    mock_response.content = [MagicMock(text='{"menu": {...}}')]
    mock_client.messages.create.return_value = mock_response
    
    # Ejecutar test
    generator = MenuGenerator('fake-api-key')
    result = generator.generate_weekly_menu(
        adults=[], 
        children=[], 
        recipes=[]
    )
    
    # Verificar
    assert result['success'] == True
    mock_client.messages.create.assert_called_once()
```

## 🔧 Desarrollo de Nuevas Funcionalidades

### Proceso Recomendado

1. **Planificación**
   - Crear issue o documentar la funcionalidad
   - Diseñar la API si es necesario
   - Identificar cambios en base de datos

2. **Implementación**
   - Crear branch: `git checkout -b feature/nueva-funcionalidad`
   - Implementar backend primero
   - Añadir tests
   - Implementar frontend
   - Actualizar documentación

3. **Testing**
   - Ejecutar tests existentes
   - Escribir tests para nueva funcionalidad
   - Probar manualmente

4. **Revisión**
   - Revisar código propio
   - Verificar que sigue convenciones
   - Actualizar documentación

5. **Merge**
   - Merge a main/master
   - Tag de versión si es necesario

### Ejemplo: Añadir Nueva Funcionalidad

#### Paso 1: Añadir Endpoint en `app.py`

```python
@app.route('/api/recipes/favorite', methods=['POST'])
def favorite_recipe():
    """Marca una receta como favorita"""
    try:
        data = request.json
        recipe_id = data.get('recipe_id')
        favorite = data.get('favorite', True)
        
        if not recipe_id:
            return jsonify({
                'success': False,
                'error': 'recipe_id es requerido'
            }), 400
        
        success = db.set_recipe_favorite(recipe_id, favorite)
        
        if success:
            return jsonify({
                'success': True,
                'message': 'Receta marcada como favorita'
            })
        else:
            return jsonify({
                'success': False,
                'error': 'Receta no encontrada'
            }), 404
            
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 400
```

#### Paso 2: Añadir Método en `database.py`

```python
def set_recipe_favorite(self, recipe_id: int, favorite: bool) -> bool:
    """
    Marca una receta como favorita o no favorita.
    
    Args:
        recipe_id: ID de la receta
        favorite: True para marcar como favorita, False para desmarcar
    
    Returns:
        True si se actualizó correctamente, False si la receta no existe
    """
    conn = self.get_connection()
    cursor = conn.cursor()
    
    try:
        # Primero verificar que existe
        cursor.execute('SELECT id FROM recipes WHERE id = ?', (recipe_id,))
        if not cursor.fetchone():
            return False
        
        # Actualizar (asumiendo que añadimos columna favorite)
        cursor.execute(
            'UPDATE recipes SET favorite = ? WHERE id = ?',
            (favorite, recipe_id)
        )
        conn.commit()
        return True
    except Exception as e:
        conn.rollback()
        raise
    finally:
        self._close_connection(conn)
```

#### Paso 3: Migración de Base de Datos

```python
# En database.py, método init_database()
if self.is_postgres:
    cursor.execute('''
        ALTER TABLE recipes 
        ADD COLUMN IF NOT EXISTS favorite BOOLEAN DEFAULT FALSE
    ''')
else:
    # SQLite no soporta ALTER TABLE ADD COLUMN IF NOT EXISTS
    # Necesitamos verificar primero
    cursor.execute('PRAGMA table_info(recipes)')
    columns = [col[1] for col in cursor.fetchall()]
    if 'favorite' not in columns:
        cursor.execute('ALTER TABLE recipes ADD COLUMN favorite BOOLEAN DEFAULT 0')
```

#### Paso 4: Añadir Test

```python
def test_set_recipe_favorite(db):
    """Test de marcar receta como favorita"""
    # Añadir receta de prueba
    recipe_data = {
        'title': 'Test Recipe',
        'ingredients': '[]',
        'instructions': 'Test instructions'
    }
    recipe_id = db.add_recipe(recipe_data)
    
    # Marcar como favorita
    success = db.set_recipe_favorite(recipe_id, True)
    assert success == True
    
    # Verificar
    recipes = db.get_all_recipes()
    recipe = next(r for r in recipes if r['id'] == recipe_id)
    assert recipe['favorite'] == True
```

#### Paso 5: Actualizar Frontend

```javascript
// En static/js/app.js
async function toggleRecipeFavorite(recipeId, favorite) {
    try {
        const response = await fetchAPI('/api/recipes/favorite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                recipe_id: recipeId,
                favorite: favorite
            })
        });
        
        if (response.success) {
            showSuccess('Receta actualizada');
            loadRecipes(); // Recargar lista
        } else {
            showError(response.error);
        }
    } catch (error) {
        showError('Error al actualizar receta');
    }
}
```

## 🐛 Debugging

### Logging

```python
import logging

# Configurar logging
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

logger = logging.getLogger(__name__)

# Usar en código
logger.debug('Detalle de debug')
logger.info('Información general')
logger.warning('Advertencia')
logger.error('Error')
logger.critical('Error crítico')
```

### Debug en Flask

```python
# En app.py, para desarrollo
if __name__ == '__main__':
    app.run(debug=True)  # Activa debug mode
```

### Debug en JavaScript

```javascript
// Usar console para debugging
console.log('Valor:', value);
console.error('Error:', error);
console.table(arrayData); // Para arrays/objetos

// Debugger (pausa ejecución)
debugger; // El navegador se detendrá aquí si DevTools está abierto
```

### Inspeccionar Base de Datos

```bash
# SQLite
sqlite3 family_kitchen.db
.tables
SELECT * FROM adults;
.schema adults

# PostgreSQL (Railway)
railway run psql $DATABASE_URL
\dt  # Listar tablas
SELECT * FROM adults;
\d adults  # Ver esquema
```

## 📦 Gestión de Dependencias

### Añadir Nueva Dependencia

```bash
# 1. Instalar
pip install nueva-dependencia

# 2. Actualizar requirements.txt
pip freeze > requirements.txt

# 3. Verificar versión específica
pip install nueva-dependencia==1.2.3
```

### Actualizar Dependencias

```bash
# Verificar versiones disponibles
pip list --outdated

# Actualizar una específica
pip install --upgrade nombre-paquete

# Actualizar todas (cuidado)
pip install --upgrade -r requirements.txt
```

## 🚢 Deployment

### Pre-Deployment Checklist

- [ ] Todas las variables de entorno configuradas
- [ ] Base de datos migrada (si hay cambios)
- [ ] Tests pasando
- [ ] Documentación actualizada
- [ ] Logs revisados
- [ ] Backup de base de datos (producción)

### Railway Deployment

```bash
# 1. Instalar Railway CLI
npm i -g @railway/cli

# 2. Login
railway login

# 3. Link proyecto
railway link

# 4. Deploy
railway up

# 5. Ver logs
railway logs

# 6. Ver variables de entorno
railway variables
```

## 📚 Recursos Útiles

### Documentación Externa

- [Flask Documentation](https://flask.palletsprojects.com/)
- [Anthropic Claude API](https://docs.anthropic.com/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [BeautifulSoup Documentation](https://www.crummy.com/software/BeautifulSoup/bs4/doc/)
- [Pytest Documentation](https://docs.pytest.org/)

### Herramientas Recomendadas

- **Postman/Insomnia**: Para probar APIs
- **DB Browser for SQLite**: Para inspeccionar base de datos local
- **VS Code**: Editor recomendado con extensiones Python
- **Git**: Control de versiones

## ❓ Preguntas Frecuentes

### ¿Cómo añado un nuevo campo a un perfil?

1. Añadir columna en `database.py` → `init_database()`
2. Actualizar método `add_adult()` o `add_child()`
3. Actualizar formulario en `templates/index.html`
4. Actualizar JavaScript en `static/js/app.js`
5. Migrar datos existentes si es necesario

### ¿Cómo cambio el modelo de IA?

Editar `menu_generator.py`:
```python
# Cambiar modelo
response = self.client.messages.create(
    model="claude-sonnet-4-20250514",  # Cambiar aquí
    # ...
)
```

### ¿Cómo añado soporte para otro sitio de recetas?

Editar `recipe_extractor.py`:
```python
def _extract_from_nuevo_sitio(self, soup, url):
    """Extracción específica para nuevo sitio"""
    # Lógica de extracción
    pass
```

---

## 🤝 Contribuir

Ver [CONTRIBUTING.md](CONTRIBUTING.md) para guía completa de contribución.

---

**¡Feliz desarrollo! 🚀**






================================================================================


ARCHIVO: DEPLOYMENT.md

# 🚀 Guía de Deployment

Guía completa para desplegar k[AI]tchen en diferentes entornos.

## 📋 Tabla de Contenidos

1. [Requisitos Previos](#requisitos-previos)
2. [Deployment Local](#deployment-local)
3. [Deployment en Railway](#deployment-en-railway)
4. [Deployment en Otros Servicios](#deployment-en-otros-servicios)
5. [Configuración Post-Deployment](#configuración-post-deployment)
6. [Troubleshooting](#troubleshooting)

## ✅ Requisitos Previos

### Cuentas Necesarias

- **Anthropic**: Para API key de Claude ([console.anthropic.com](https://console.anthropic.com))
- **Railway** (opcional): Para hosting ([railway.app](https://railway.app))
- **GitHub** (opcional): Para control de versiones

### Herramientas

- Python 3.8+
- Git
- Railway CLI (si usas Railway)

## 🏠 Deployment Local

### Windows

#### Opción 1: Script Batch

```batch
# Usar start_server.bat
start_server.bat
```

#### Opción 2: Manual

```powershell
# 1. Activar entorno virtual (si existe)
.\venv\Scripts\activate

# 2. Instalar dependencias
pip install -r requirements.txt

# 3. Configurar .env
# Editar .env y añadir ANTHROPIC_API_KEY

# 4. Inicializar base de datos
python init.py

# 5. Ejecutar servidor
python app.py
```

El servidor estará disponible en `http://localhost:7000`

### Linux/Mac

```bash
# 1. Activar entorno virtual
source venv/bin/activate

# 2. Instalar dependencias
pip install -r requirements.txt

# 3. Configurar .env
nano .env  # Añadir ANTHROPIC_API_KEY

# 4. Inicializar base de datos
python init.py

# 5. Ejecutar servidor
python app.py
```

### Con Gunicorn (Producción Local)

```bash
# Instalar gunicorn
pip install gunicorn

# Ejecutar con gunicorn
gunicorn app:app --bind 0.0.0.0:7000 --workers 2 --timeout 120
```

## 🚂 Deployment en Railway

Railway es la plataforma recomendada para producción.

### Paso 1: Preparar el Proyecto

Asegúrate de tener estos archivos:

- `Procfile` (ya incluido)
- `railway.toml` (ya incluido)
- `requirements.txt` (ya incluido)
- `.env.example` (para referencia)

### Paso 2: Crear Proyecto en Railway

1. Ve a [railway.app](https://railway.app)
2. Inicia sesión o crea cuenta
3. Click en "New Project"
4. Selecciona "Deploy from GitHub repo" o "Empty Project"

### Paso 3: Conectar Repositorio (si usas GitHub)

1. En Railway, selecciona "Deploy from GitHub repo"
2. Autoriza Railway a acceder a tu repositorio
3. Selecciona el repositorio
4. Railway detectará automáticamente Python y Flask

### Paso 4: Configurar Variables de Entorno

En Railway dashboard, ve a "Variables" y añade:

```env
ANTHROPIC_API_KEY=sk-ant-api03-tu-key-aqui
SECRET_KEY=genera-una-clave-secreta-aleatoria
FLASK_ENV=production
DATABASE_URL=postgresql://... (Railway lo proporciona automáticamente)
CORS_ORIGINS=https://tu-dominio.com,https://www.tu-dominio.com
PORT=7000 (Railway lo establece automáticamente)
```

**Cómo generar SECRET_KEY**:
```python
import secrets
print(secrets.token_hex(32))
```

### Paso 5: Añadir Base de Datos PostgreSQL

1. En Railway dashboard, click "New"
2. Selecciona "Database" → "Add PostgreSQL"
3. Railway creará automáticamente la base de datos
4. La variable `DATABASE_URL` se añadirá automáticamente

### Paso 6: Deploy

Railway detectará automáticamente:
- `Procfile` para el comando de inicio
- `requirements.txt` para instalar dependencias
- Python como lenguaje

El deploy comenzará automáticamente. Puedes ver el progreso en "Deployments".

### Paso 7: Configurar Dominio

1. En Railway dashboard, ve a "Settings"
2. Click "Generate Domain" o añade tu dominio personalizado
3. Railway proporcionará una URL como `tu-proyecto.railway.app`

### Paso 8: Verificar Deployment

```bash
# Ver logs
railway logs

# Verificar que el servidor está corriendo
curl https://tu-proyecto.railway.app/health
```

Deberías recibir:
```json
{
  "status": "ok",
  "timestamp": "2024-01-15T10:30:00"
}
```

## 🌐 Deployment en Otros Servicios

### Heroku

#### 1. Crear `Procfile`

```
web: gunicorn app:app --bind 0.0.0.0:$PORT --workers 2 --timeout 120
```

#### 2. Crear `runtime.txt`

```
python-3.11.0
```

#### 3. Deploy

```bash
# Instalar Heroku CLI
# https://devcenter.heroku.com/articles/heroku-cli

# Login
heroku login

# Crear app
heroku create tu-app-name

# Añadir PostgreSQL
heroku addons:create heroku-postgresql:hobby-dev

# Configurar variables
heroku config:set ANTHROPIC_API_KEY=tu-key
heroku config:set SECRET_KEY=tu-secret-key
heroku config:set FLASK_ENV=production

# Deploy
git push heroku main
```

### DigitalOcean App Platform

1. Conecta tu repositorio de GitHub
2. DigitalOcean detectará Flask automáticamente
3. Configura variables de entorno en el dashboard
4. Añade base de datos PostgreSQL
5. Deploy automático

### AWS Elastic Beanstalk

#### 1. Crear `.ebextensions/python.config`

```yaml
option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: app:app
```

#### 2. Deploy

```bash
# Instalar EB CLI
pip install awsebcli

# Inicializar
eb init

# Crear entorno
eb create

# Deploy
eb deploy
```

### Docker

#### 1. Crear `Dockerfile`

```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 7000

CMD ["gunicorn", "app:app", "--bind", "0.0.0.0:7000", "--workers", "2", "--timeout", "120"]
```

#### 2. Crear `docker-compose.yml`

```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "7000:7000"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=postgresql://user:pass@db:5432/kitchen
      - FLASK_ENV=production
    depends_on:
      - db
  
  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=kitchen
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

#### 3. Ejecutar

```bash
docker-compose up -d
```

## ⚙️ Configuración Post-Deployment

### 1. Inicializar Base de Datos

Si es la primera vez que despliegas, necesitas inicializar las tablas:

```bash
# Opción 1: Via Railway CLI
railway run python init.py

# Opción 2: Via SSH/Shell del servicio
python init.py
```

### 2. Verificar Variables de Entorno

```bash
# Railway
railway variables

# Heroku
heroku config

# Verificar que todas están configuradas:
# - ANTHROPIC_API_KEY
# - SECRET_KEY
# - DATABASE_URL
# - FLASK_ENV
```

### 3. Probar Endpoints

```bash
# Health check
curl https://tu-dominio.com/health

# Obtener perfiles (debería devolver array vacío inicialmente)
curl https://tu-dominio.com/api/adults
```

### 4. Configurar CORS

Si vas a acceder desde un dominio diferente:

```env
CORS_ORIGINS=https://tu-frontend.com,https://www.tu-frontend.com
```

O para desarrollo:
```env
CORS_ORIGINS=*
```

⚠️ **Advertencia**: `CORS_ORIGINS=*` solo para desarrollo. En producción, especifica dominios exactos.

## 🔍 Troubleshooting

### Error: "ANTHROPIC_API_KEY no configurada"

**Solución**:
1. Verifica que la variable está en Railway/Heroku/etc.
2. Verifica que el nombre es exactamente `ANTHROPIC_API_KEY`
3. Reinicia el servicio después de añadir la variable

### Error: "Database connection failed"

**Solución**:
1. Verifica que `DATABASE_URL` está configurada
2. Verifica que la base de datos está corriendo (Railway/Heroku)
3. Verifica formato de URL: `postgresql://user:pass@host:port/db`

### Error: "Port already in use"

**Solución**:
- En producción, usa la variable `PORT` del servicio
- No hardcodees el puerto en el código
- Railway/Heroku establecen `PORT` automáticamente

### Error: "Module not found"

**Solución**:
1. Verifica que `requirements.txt` incluye todas las dependencias
2. Rebuild el proyecto
3. Verifica logs de build para errores de instalación

### La aplicación no responde

**Checklist**:
- [ ] ¿El servicio está corriendo? (ver logs)
- [ ] ¿Las variables de entorno están configuradas?
- [ ] ¿La base de datos está accesible?
- [ ] ¿El dominio está correctamente configurado?
- [ ] ¿Hay errores en los logs?

### Ver Logs

```bash
# Railway
railway logs

# Heroku
heroku logs --tail

# Docker
docker-compose logs -f web
```

## 📊 Monitoreo

### Health Check Endpoint

El endpoint `/health` está disponible para monitoreo:

```bash
curl https://tu-dominio.com/health
```

Respuesta esperada:
```json
{
  "status": "ok",
  "timestamp": "2024-01-15T10:30:00"
}
```

### Logs Recomendados

Monitorea estos eventos en los logs:
- Errores de API de Anthropic
- Errores de base de datos
- Timeouts en generación de menús
- Errores de extracción de recetas

### Métricas Importantes

- Tiempo de respuesta de API
- Tasa de éxito de generación de menús
- Uso de memoria y CPU
- Errores 500

## 🔄 Actualización de Deployment

### Proceso de Actualización

1. **Desarrollo Local**
   ```bash
   git checkout -b feature/nueva-funcionalidad
   # Hacer cambios
   git commit -m "Añadir nueva funcionalidad"
   ```

2. **Testing**
   ```bash
   python run_tests.py
   ```

3. **Push a Repositorio**
   ```bash
   git push origin feature/nueva-funcionalidad
   ```

4. **Merge a Main**
   - Crear Pull Request
   - Revisar cambios
   - Merge

5. **Deploy Automático**
   - Railway/Heroku detectará cambios
   - Deploy automático comenzará
   - Verificar logs

### Rollback

Si algo sale mal:

```bash
# Railway
railway rollback

# Heroku
heroku releases:rollback v123

# Docker
docker-compose down
git checkout previous-version
docker-compose up -d
```

## 🔐 Seguridad en Producción

### Checklist de Seguridad

- [ ] `SECRET_KEY` es aleatoria y segura
- [ ] `ANTHROPIC_API_KEY` no está en el código
- [ ] `DATABASE_URL` contiene credenciales seguras
- [ ] CORS está configurado correctamente (no `*` en producción)
- [ ] HTTPS está habilitado
- [ ] Variables de entorno no están en el repositorio
- [ ] `.env` está en `.gitignore`

### Variables Sensibles

**NUNCA** commitees:
- `.env`
- `ANTHROPIC_API_KEY`
- `SECRET_KEY`
- `DATABASE_URL` con credenciales

**SÍ** commitea:
- `.env.example` (sin valores reales)
- `requirements.txt`
- `Procfile`
- `railway.toml`

## 📚 Recursos Adicionales

- [Railway Documentation](https://docs.railway.app/)
- [Heroku Python Guide](https://devcenter.heroku.com/articles/getting-started-with-python)
- [Flask Deployment](https://flask.palletsprojects.com/en/latest/deploying/)
- [Gunicorn Documentation](https://docs.gunicorn.org/)

---

## ✅ Checklist de Deployment

### Pre-Deployment

- [ ] Código probado localmente
- [ ] Tests pasando
- [ ] Variables de entorno documentadas
- [ ] `.env.example` actualizado
- [ ] `requirements.txt` actualizado
- [ ] Documentación actualizada

### Deployment

- [ ] Servicio creado (Railway/Heroku/etc.)
- [ ] Base de datos configurada
- [ ] Variables de entorno configuradas
- [ ] Deploy exitoso
- [ ] Health check funcionando

### Post-Deployment

- [ ] Base de datos inicializada
- [ ] Endpoints API funcionando
- [ ] Frontend accesible
- [ ] Logs sin errores críticos
- [ ] Dominio configurado (si aplica)

---

**¡Deployment exitoso! 🎉**



