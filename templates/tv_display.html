<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>k[AI]tchen ¬∑ Weekly Menu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --black: #0A0A0A;
            --charcoal: #1A1A1A;
            --gold: #D4AF37;
            --gold-dark: #C9A227;
            --sage: #8AA193;
            --sage-dark: #6B8575;
            --blue-adults: #3B82F6;
            --blue-adults-dark: #2563EB;
            --orange-children: #F97316;
            --orange-children-dark: #EA580C;
            --silver: #CBD5E0;
            --white: #FFFFFF;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--black);
            color: var(--white);
            padding: 2rem;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated gradient background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(138, 161, 147, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            animation: shift 20s ease-in-out infinite;
        }

        @keyframes shift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Grain texture */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 1;
            opacity: 0.5;
        }

        .tv-container {
            max-width: 1920px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
            animation: fadeIn 1s ease-out;
            height: calc(100vh - 4rem); /* Subtract body padding (2rem top + 2rem bottom) */
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Top Bar with Clock, Weather, QR Code */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 1rem;
            border-radius: 16px;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .clock-weather {
            display: flex;
            gap: 3rem;
            align-items: center;
        }

        .clock {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            color: var(--white);
            letter-spacing: 2px;
        }

        .date-display {
            font-size: 1.2rem;
            color: var(--silver);
            font-weight: 400;
        }

        .weather {
            font-size: 1.3rem;
            color: var(--silver);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .qr-containers-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            flex-wrap: nowrap;
            justify-content: flex-end;
        }
        
        #recipe-qr-container {
            display: flex !important;
            gap: 1rem !important;
            align-items: flex-start !important;
            flex-wrap: nowrap !important;
        }
        
        @media (max-width: 1600px) {
            .qr-containers-wrapper {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        .qr-code {
            width: 120px;
            height: 120px;
            background: var(--white);
            border-radius: 12px;
            padding: 8px;
        }

        .qr-label {
            font-size: 0.9rem;
            color: var(--silver);
            text-align: center;
            font-weight: 500;
        }

        /* Week Navigation - Slimmer */
        .week-nav {
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 0.75rem 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .week-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
        }

        .week-day-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1rem 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .week-day-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.05);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .week-day-card:hover::before {
            opacity: 1;
        }

        .week-day-card:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .week-day-card.active {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--black);
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(212, 175, 55, 0.4), 0 0 0 1px rgba(212, 175, 55, 0.2);
            border-color: var(--gold);
        }

        .week-day-card.active::before {
            opacity: 0;
        }

        .week-day-name {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Inter', sans-serif;
        }

        .week-day-date {
            font-size: 1.6rem;
            font-weight: 700;
            opacity: 0.9;
        }

        /* Main Content Area - Split Screen */
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 4px 1fr;
            gap: 2rem;
            overflow: hidden;
            min-height: 0; /* Critical for flex children to allow scrolling */
            height: 100%; /* Ensure it takes available space */
        }

        .divider {
            background: linear-gradient(180deg, transparent, var(--gold), transparent);
            width: 4px;
            border-radius: 2px;
        }

        .menu-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2.5rem;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            min-height: 0; /* Critical for grid children to allow scrolling */
            max-height: 100%; /* Ensure it doesn't exceed parent */
            height: 100%; /* Take full height of grid cell */
            display: flex;
            flex-direction: column;
            position: relative; /* Ensure scroll works */
            /* Ensure scroll works on touch devices */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            transition: all 0.3s ease;
        }

        .menu-panel:hover {
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Background accent blur effect */
        .menu-panel.adults::after {
            content: '';
            position: absolute;
            top: -100px;
            right: -100px;
            width: 300px;
            height: 300px;
            background: var(--blue-adults);
            opacity: 0.1;
            filter: blur(100px);
            pointer-events: none;
            border-radius: 50%;
            z-index: 0;
        }

        .menu-panel.children::after {
            content: '';
            position: absolute;
            top: -100px;
            right: -100px;
            width: 300px;
            height: 300px;
            background: var(--orange-children);
            opacity: 0.1;
            filter: blur(100px);
            pointer-events: none;
            border-radius: 50%;
            z-index: 0;
        }

        .menu-panel.adults {
            border-left: 6px solid var(--blue-adults);
        }

        .menu-panel.children {
            border-left: 6px solid var(--orange-children);
        }

        .panel-header {
            text-align: center;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        .panel-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -1px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .panel-title .emoji {
            font-size: 1.8rem;
        }

        .panel-title.adults {
            color: var(--blue-adults);
            text-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
        }

        .panel-title.children {
            color: var(--orange-children);
            text-shadow: 0 0 30px rgba(249, 115, 22, 0.3);
        }

        .panel-subtitle {
            font-size: 1.2rem;
            color: var(--silver);
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 2px;
            white-space: nowrap;
        }

        .meal-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2.5rem;
            flex: 1;
            min-height: 0;
            width: 100%;
            overflow: visible; /* Allow content to overflow for scrolling */
            position: relative;
            z-index: 2; /* Above blur effect */
        }

        /* NEW ZENITH-STYLE MEAL CARD - All styles are inline in HTML */
        .meal-card {
            /* Base styles only - all visual styles are inline */
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Ingredient badges */
        .ingredient-badges {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
            margin-top: 0.5rem !important;
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        .ingredient-badge {
            display: inline-block !important;
            padding: 0.75rem 1.25rem !important;
            background: rgba(255, 255, 255, 0.08) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            border-radius: 12px !important;
            font-size: 1rem !important;
            font-weight: 500 !important;
            color: rgba(255, 255, 255, 0.95) !important;
            transition: all 0.2s ease !important;
            white-space: nowrap !important;
            margin: 0 !important;
            line-height: 1.5 !important;
        }

        .ingredient-badge:hover {
            background: rgba(255, 255, 255, 0.12) !important;
            border-color: rgba(255, 255, 255, 0.25) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
        }

        /* Recipe link styles */
        .recipe-link a {
            transform: translateY(0);
        }
        
        .recipe-base-text {
            color: var(--silver);
            font-size: 1rem;
            font-style: italic;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        

        .loading {
            text-align: center;
            padding: 8rem 2rem;
            grid-column: 1 / -1; /* Span all columns */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100%;
        }

        .spinner {
            width: 100px;
            height: 100px;
            border: 6px solid rgba(255, 255, 255, 0.1);
            border-top: 6px solid var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading p {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--silver);
            font-weight: 300;
        }

        .no-menu {
            text-align: center;
            padding: 8rem 2rem;
            grid-column: 1 / -1; /* Span all columns */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100%;
        }

        .no-menu h2 {
            font-family: 'Playfair Display', serif;
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: var(--white);
        }

        .no-menu p {
            font-size: 2rem;
            color: var(--silver);
            font-weight: 300;
        }

        .auto-refresh {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            color: var(--silver);
            font-weight: 500;
            letter-spacing: 1px;
            z-index: 10;
        }

        /* Scrollbar styling - Make it more visible and functional */
        .menu-panel::-webkit-scrollbar {
            width: 12px;
        }

        .menu-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            margin: 0.5rem 0;
        }

        .menu-panel::-webkit-scrollbar-thumb {
            background: var(--gold);
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .menu-panel::-webkit-scrollbar-thumb:hover {
            background: var(--gold-dark);
        }

        /* Ensure scrollbar is always visible when content overflows */
        .menu-panel {
            scrollbar-width: thin;
            scrollbar-color: var(--gold) rgba(255, 255, 255, 0.1);
        }

        /* Responsive Design */
        @media (max-width: 1600px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
            }
            
            .divider {
                display: none;
            }
            
        }

        @media (max-width: 1200px) {
            .week-days {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .panel-title {
                font-size: 2.5rem;
            }
        }

        /* Tablet (iPad) */
        @media (max-width: 1024px) {
            body {
                padding: 1rem;
            }

            .tv-container {
                height: calc(100vh - 2rem);
            }

            .top-bar {
                padding: 0.5rem 1rem;
                margin-bottom: 0.75rem;
            }

            .clock {
                font-size: 1.5rem;
            }

            .date-display {
                font-size: 1rem;
            }

            .week-nav {
                padding: 0.5rem 1rem;
                margin-bottom: 0.75rem;
            }

            .week-days {
                grid-template-columns: repeat(7, 1fr);
                gap: 0.5rem;
            }

            .week-day-card {
                padding: 0.75rem 0.5rem;
            }

            .week-day-name {
                font-size: 1.1rem;
            }

            .week-day-date {
                font-size: 1.3rem;
            }

            .menu-panel {
                padding: 1.5rem;
            }

            .panel-title {
                font-size: 2rem;
            }

            .meal-grid {
                gap: 1.5rem;
            }

            .qr-code {
                width: 80px;
                height: 80px;
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            .tv-container {
                height: calc(100vh - 1rem);
            }

            .top-bar {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .clock-weather {
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }

            .clock {
                font-size: 1.2rem;
            }

            .date-display {
                font-size: 0.9rem;
            }

            .weather {
                font-size: 1rem;
            }

            .qr-containers-wrapper {
                flex-direction: column;
                width: 100%;
                align-items: center;
            }

            .qr-code {
                width: 60px;
                height: 60px;
            }

            .week-nav {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
            }

            .week-days {
                grid-template-columns: repeat(7, 1fr);
                gap: 0.25rem;
            }

            .week-day-card {
                padding: 0.5rem 0.25rem;
            }

            .week-day-name {
                font-size: 0.9rem;
                margin-bottom: 0.1rem;
            }

            .week-day-date {
                font-size: 1rem;
            }

            .main-content {
                gap: 1rem;
            }

            .menu-panel {
                padding: 1rem;
                border-radius: 16px;
            }

            .panel-header {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 1rem;
            }

            .panel-title {
                font-size: 1.5rem;
            }

            .panel-subtitle {
                font-size: 1rem;
            }

            .meal-grid {
                gap: 1rem;
            }

            .auto-refresh {
                bottom: 0.5rem;
                right: 0.5rem;
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
        }

        /* Small Mobile */
        @media (max-width: 480px) {
            .week-day-name {
                font-size: 0.75rem;
            }

            .week-day-date {
                font-size: 0.9rem;
            }

            .panel-title {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="tv-container">
        <!-- Top Bar: Clock, Weather, QR Code -->
        <div class="top-bar">
            <div class="clock-weather">
                <div>
                    <div class="clock" id="currentTime"></div>
                    <div class="date-display" id="currentDate"></div>
                </div>
                <div class="weather" id="weatherWidget">
                    <span>üå§Ô∏è</span>
                    <span id="weatherText">Loading...</span>
                </div>
            </div>
            <div class="qr-containers-wrapper">
            <div class="qr-container">
                <div class="qr-code" id="qrCode"></div>
                <div class="qr-label">üì± Shopping List</div>
                </div>
                <div id="recipe-qr-container"></div>
            </div>
        </div>

        <!-- Week Navigation -->
        <div class="week-nav">
            <div class="week-days" id="week-days-nav">
                <!-- Day cards will be rendered here -->
            </div>
        </div>

        <!-- Main Content: Split Screen -->
        <div class="main-content" id="menu-content">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading your personalized menu...</p>
            </div>
        </div>

        <div class="auto-refresh">
            Auto-refresh enabled
        </div>
    </div>

    <script>
        const diasSemana = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
        const diasES = {
            'lunes': 'Lunes',
            'martes': 'Martes',
            'mi√©rcoles': 'Mi√©rcoles',
            'jueves': 'Jueves',
            'viernes': 'Viernes',
            's√°bado': 'S√°bado',
            'domingo': 'Domingo'
        };
        
        const diasEN = {
            'lunes': 'Monday',
            'martes': 'Tuesday',
            'mi√©rcoles': 'Wednesday',
            'jueves': 'Thursday',
            'viernes': 'Friday',
            's√°bado': 'Saturday',
            'domingo': 'Sunday'
        };
        
        const mesesES = [
            'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
            'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
        ];
        
        const mesesEN = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        
        // Get current week start (Monday) - same logic as app.js
        function getCurrentWeekStart() {
            // Use local date components to avoid timezone conversion issues
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const date = today.getDate();
            
            // Create date using local components (avoids UTC conversion)
            const localToday = new Date(year, month, date, 0, 0, 0, 0);
            
            // Calculate Monday of the week
            const day = localToday.getDay(); // 0 = Sunday, 1 = Monday, etc.
            let diff = localToday.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            
            const monday = new Date(localToday);
            monday.setDate(diff);
            monday.setHours(0, 0, 0, 0);
            
            return monday;
        }
        
        // Get current day name (lunes, martes, etc.)
        function getCurrentDayName() {
            const today = new Date();
            const day = today.getDay();
            // Convert JS day (0=Sunday) to our day names (lunes=0)
            const dayMap = [6, 0, 1, 2, 3, 4, 5]; // Sunday=6, Monday=0, etc.
            const dayIndex = dayMap[day];
            const dayNames = ['lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado', 'domingo'];
            return dayNames[dayIndex];
        }
        
        // Get date for a specific day of the week
        function getDateForDay(dayKey) {
            const dayMap = { 'lunes': 0, 'martes': 1, 'mi√©rcoles': 2, 'jueves': 3, 'viernes': 4, 's√°bado': 5, 'domingo': 6 };
            const dayIndex = dayMap[dayKey];
            if (dayIndex === undefined) return new Date();
            
            const weekStart = getCurrentWeekStart();
            const date = new Date(weekStart);
            date.setDate(weekStart.getDate() + dayIndex);
            return date;
        }
        
        // Get formatted day with calendar date
        function getDayWithDate(dayKey, lang = 'es') {
            const date = getDateForDay(dayKey);
            const dayName = lang === 'es' ? diasES[dayKey] : diasEN[dayKey];
            const dayNumber = date.getDate();
            return `${dayName} ${dayNumber}`;
        }

        let currentMenu = null;
        let selectedDay = null;

        // Update clock and date
        function updateDateTime() {
            const now = new Date();
            const dayIndex = now.getDay();
            const dayName = diasSemana[dayIndex];
            const day = now.getDate();
            const monthES = mesesES[now.getMonth()];
            const monthEN = mesesEN[now.getMonth()];
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
            document.getElementById('currentDate').textContent = 
                `${diasES[dayName]} ${day} ${monthES} / ${diasEN[dayName]} ${day} ${monthEN} ${year}`;
            
            // Always set selectedDay to today
            const currentDayName = getCurrentDayName();
            if (selectedDay !== currentDayName) {
                selectedDay = currentDayName;
                console.log('[TV] Setting selectedDay to today:', selectedDay);
                // Update menu display if menu is already loaded
                if (currentMenu) {
                    displayMenu();
                    updateWeekNav();
                }
            }
        }

        // Update weather (placeholder - you can integrate with a weather API)
        function updateWeather() {
            // Placeholder - you can integrate with OpenWeatherMap or similar
            document.getElementById('weatherText').textContent = '22¬∞C Sunny';
        }

        // Generate QR Code for shopping list
        function generateQRCode() {
            const qrContainer = document.getElementById('qrCode');
            if (qrContainer && typeof QRCode !== 'undefined') {
                const shoppingListUrl = `${window.location.origin}/?tab=shopping`;
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: shoppingListUrl,
                    width: 120,
                    height: 120,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }
        
        // Generate QR codes for recipes
        function generateRecipeQRCodes(recipes) {
            const container = document.getElementById('recipe-qr-container');
            if (!container || !recipes || recipes.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            // Only show unique recipes
            const uniqueRecipes = [...new Set(recipes.filter(r => r && r !== 'Original' && r !== ''))];
            
            if (uniqueRecipes.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '';
            container.style.display = 'flex';
            container.style.gap = '1rem';
            container.style.alignItems = 'flex-start';
            container.style.flexWrap = 'nowrap';
            
            uniqueRecipes.forEach((recipeTitle, index) => {
                const recipeViewUrl = `${window.location.origin}/recipe/view?title=${encodeURIComponent(recipeTitle)}`;
                const qrId = `recipe-qr-${index}`;
                
                const qrWrapper = document.createElement('div');
                qrWrapper.className = 'qr-container';
                qrWrapper.style.display = 'flex';
                qrWrapper.style.flexDirection = 'column';
                qrWrapper.style.alignItems = 'center';
                qrWrapper.style.gap = '0.5rem';
                qrWrapper.style.flexShrink = '0';
                qrWrapper.innerHTML = `
                    <div class="qr-code" id="${qrId}"></div>
                    <div class="qr-label">üìñ ${recipeTitle.length > 15 ? recipeTitle.substring(0, 15) + '...' : recipeTitle}</div>
                `;
                container.appendChild(qrWrapper);
                
                // Generate QR code
                setTimeout(() => {
                    const qrElement = document.getElementById(qrId);
                    if (qrElement && typeof QRCode !== 'undefined') {
                        new QRCode(qrElement, {
                            text: recipeViewUrl,
                            width: 120,
                            height: 120,
                            colorDark: '#000000',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    }
                }, 100 * (index + 1));
            });
        }

        // Get food image URL (placeholder - you can use Unsplash API)
        function getFoodImage(mealName) {
            // Placeholder - in production, use Unsplash API or similar
            const encodedName = encodeURIComponent(mealName);
            return `https://source.unsplash.com/400x300/?food,${encodedName}`;
        }

        async function loadMenu() {
            try {
                // Always load current week menu
                const response = await fetch('/api/menu/current-week');
                
                if (response.status === 404) {
                    console.log('[TV] No menu for current week, trying latest menu...');
                    // Fallback to latest menu
                    try {
                        const latestResponse = await fetch('/api/menu/latest');
                        if (latestResponse.ok) {
                            const latestResult = await latestResponse.json();
                            console.log('[TV] Latest menu API response:', latestResult);
                            
                            if (latestResult.success && latestResult.data) {
                                let menuData = latestResult.data.menu_data;
                                
                                if (typeof menuData === 'string') {
                                    try {
                                        menuData = JSON.parse(menuData);
                                    } catch (e) {
                                        console.error('[TV] Failed to parse menu_data:', e);
                                        showNoMenu();
                                        return;
                                    }
                                }
                                
                                currentMenu = menuData;
                                console.log('[TV] Latest menu loaded successfully as fallback');
                                
                                // Always set selectedDay to today if not already set
                                if (!selectedDay) {
                                    selectedDay = getCurrentDayName();
                                    console.log('[TV] Setting selectedDay to today:', selectedDay);
                                }
                                
                                displayMenu();
                                return;
                            }
                        }
                    } catch (fallbackError) {
                        console.error('[TV] Error loading latest menu:', fallbackError);
                    }
                    
                    // If fallback also failed, show no menu
                    showNoMenu();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('[TV] Menu API response:', result);
                
                if (result.success && result.data) {
                    let menuData = result.data.menu_data;
                    
                    if (typeof menuData === 'string') {
                        try {
                            menuData = JSON.parse(menuData);
                        } catch (e) {
                            console.error('[TV] Failed to parse menu_data:', e);
                            showNoMenu();
                            return;
                        }
                    }
                    
                    currentMenu = menuData;
                    console.log('[TV] Menu loaded successfully');
                    
                    // Always set selectedDay to today if not already set
                    if (!selectedDay) {
                        selectedDay = getCurrentDayName();
                        console.log('[TV] Setting selectedDay to today:', selectedDay);
                    }
                    
                    displayMenu();
                } else {
                    showNoMenu();
                }
            } catch (error) {
                console.error('[TV] Error loading menu:', error);
                // Try fallback to latest menu on error
                try {
                    const latestResponse = await fetch('/api/menu/latest');
                    if (latestResponse.ok) {
                        const latestResult = await latestResponse.json();
                        if (latestResult.success && latestResult.data) {
                            let menuData = latestResult.data.menu_data;
                            if (typeof menuData === 'string') {
                                try {
                                    menuData = JSON.parse(menuData);
                                } catch (e) {
                                    console.error('[TV] Failed to parse latest menu_data:', e);
                                    showNoMenu();
                                    return;
                                }
                            }
                            currentMenu = menuData;
                            if (!selectedDay) {
                                selectedDay = getCurrentDayName();
                            }
                            console.log('[TV] Latest menu loaded successfully as error fallback');
                            displayMenu();
                            return;
                        }
                    }
                } catch (fallbackError) {
                    console.error('[TV] Error loading latest menu fallback:', fallbackError);
                }
                showNoMenu();
            }
        }
        
        // Search for recipe by title and get URL
        async function getRecipeUrl(recipeTitle) {
            if (!recipeTitle || recipeTitle === 'Original' || recipeTitle === '') {
                return null;
            }
            
            try {
                const response = await fetch(`/api/recipes/search?title=${encodeURIComponent(recipeTitle)}`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.url) {
                    return result.data.url;
                }
            } catch (error) {
                console.warn('[TV] Error searching for recipe:', error);
            }
            
            return null;
        }

        function selectDay(day) {
            selectedDay = day;
            console.log('[TV] Selected day:', selectedDay);
            displayMenu();
            updateWeekNav();
        }

        function updateWeekNav() {
            const navContainer = document.getElementById('week-days-nav');
            if (!navContainer) return;
            
            navContainer.innerHTML = '';
            
            ['lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado', 'domingo'].forEach((day) => {
                const dayDate = getDateForDay(day);
                const card = document.createElement('div');
                card.className = `week-day-card ${day === selectedDay ? 'active' : ''}`;
                card.onclick = () => selectDay(day);
                
                card.innerHTML = `
                    <div class="week-day-name">${diasES[day].substring(0, 3).toUpperCase()}</div>
                    <div class="week-day-date">${dayDate.getDate()}</div>
                `;
                
                navContainer.appendChild(card);
            });
        }

        async function displayMenu() {
            const container = document.getElementById('menu-content');
            
            if (!currentMenu) {
                showNoMenu();
                return;
            }
            
            // Check for new structure (two separate menus)
            const hasNewStructure = currentMenu.menu_adultos || currentMenu.menu_ninos;
            
            if (hasNewStructure) {
                await displaySeparateMenus();
                return;
            }
            
            // Fallback to old structure
            if (!currentMenu.dias) {
                showNoMenu();
                return;
            }

            const dayData = currentMenu.dias[selectedDay];
            
            if (!dayData) {
                showNoMenu();
                return;
            }

            // Render old structure (not used in new design, but kept for compatibility)
            showNoMenu();
        }

        // Helper function to normalize day names (remove accents for matching)
        function normalizeDayName(dayName) {
            if (!dayName) return '';
            
            // Direct mapping for Spanish day names
            const dayMap = {
                'lunes': 'lunes',
                'martes': 'martes',
                'mi√©rcoles': 'miercoles',
                'miercoles': 'miercoles',
                'jueves': 'jueves',
                'viernes': 'viernes',
                's√°bado': 'sabado',
                'sabado': 'sabado',
                'domingo': 'domingo'
            };
            
            const lower = dayName.toLowerCase().trim();
            const result = dayMap[lower] || lower.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            console.log('[TV] normalizeDayName: "' + dayName + '" -> "' + result + '"');
            return result;
        }
        
        // Helper function to get day data from menu, trying multiple variations
        function getDayDataFromMenu(menuDias, dayName) {
            if (!menuDias || !dayName) {
                console.log('[TV] getDayDataFromMenu: Invalid params', { hasMenuDias: !!menuDias, dayName });
                return null;
            }
            
            const availableKeys = Object.keys(menuDias);
            console.log('[TV] getDayDataFromMenu: Looking for "' + dayName + '" in menu keys:', availableKeys);
            
            // Try exact match first (case-sensitive)
            if (menuDias[dayName]) {
                console.log('[TV] getDayDataFromMenu: Found exact match for "' + dayName + '"');
                return menuDias[dayName];
            }
            
            // Try normalized name (without accents)
            const normalized = normalizeDayName(dayName);
            console.log('[TV] getDayDataFromMenu: Normalized "' + dayName + '" to "' + normalized + '"');
            
            // Always try normalized version, even if it's the same
            if (menuDias[normalized]) {
                console.log('[TV] getDayDataFromMenu: Found normalized match for "' + normalized + '"');
                return menuDias[normalized];
            }
            
            // Try all keys to find a match (case-insensitive, accent-insensitive)
            console.log('[TV] getDayDataFromMenu: Searching all keys with normalized term "' + normalized + '"');
            
            for (const key of availableKeys) {
                const keyNormalized = normalizeDayName(key);
                console.log('[TV] getDayDataFromMenu: Comparing key "' + key + '" (normalized: "' + keyNormalized + '") with "' + normalized + '"');
                if (keyNormalized === normalized) {
                    console.log('[TV] getDayDataFromMenu: Found match! Key "' + key + '" (normalized: "' + keyNormalized + '") matches "' + normalized + '"');
                    return menuDias[key];
                }
            }
            
            console.log('[TV] getDayDataFromMenu: No match found for "' + dayName + '" (normalized: "' + normalized + '")');
            console.log('[TV] getDayDataFromMenu: Available normalized keys:', availableKeys.map(k => normalizeDayName(k)));
            return null;
        }

        async function displaySeparateMenus() {
            const container = document.getElementById('menu-content');
            const mealIcons = {
                'desayuno': 'üåÖ',
                'comida': 'üçΩÔ∏è',
                'merienda': '‚òï',
                'cena': 'üåô'
            };

            const mealNames = {
                'desayuno': { es: 'Desayuno', en: 'Breakfast' },
                'comida': { es: 'Comida', en: 'Lunch' },
                'merienda': { es: 'Merienda', en: 'Snack' },
                'cena': { es: 'Cena', en: 'Dinner' }
            };
            
            // Helper function to render a meal card with zenith-style design
            // Returns { html: string, recipeBase: string }
            async function renderMealCard(meal, mealType, mealNames, isAdult) {
                const mealName = typeof meal.nombre === 'string' ? meal.nombre : (meal.nombre?.name || 'N/A');
                const prepTime = typeof meal.tiempo_prep === 'number' ? meal.tiempo_prep : (meal.tiempo_prep?.value || meal.tiempo_prep || '');
                const calories = typeof meal.calorias === 'number' ? meal.calorias : (meal.calorias?.value || meal.calorias || '');
                const ingredients = Array.isArray(meal.ingredientes) ? meal.ingredientes : [];
                const recipeBase = typeof meal.receta_base === 'string' ? meal.receta_base : '';
                const adaptaciones = typeof meal.adaptaciones === 'string' ? meal.adaptaciones : '';
                const notas = typeof meal.notas === 'string' ? meal.notas : '';
                const porqueSeleccionada = typeof meal.porque_seleccionada === 'string' ? meal.porque_seleccionada : '';
                const instrucciones = typeof meal.instrucciones === 'string' ? meal.instrucciones : '';
                
                // Extract nutrients
                const nutrientes = meal.nutrientes || {};
                const proteinas = nutrientes.proteinas || '';
                const carbohidratos = nutrientes.carbohidratos || '';
                const grasas = nutrientes.grasas || '';
                
                // Format ingredients as badges
                let ingredientsBadgesHtml = '';
                if (ingredients.length > 0) {
                    const badges = ingredients.map(ing => 
                        `<span class="ingredient-badge">${ing}</span>`
                    ).join('');
                    ingredientsBadgesHtml = `<div class="ingredient-badges">${badges}</div>`;
                }
                
                // Build nutrition focus grid
                let nutritionHtml = '';
                const nutritionItems = [];
                if (proteinas) nutritionItems.push({ key: 'PROTEIN', val: proteinas });
                if (carbohidratos) nutritionItems.push({ key: 'CARBS', val: carbohidratos });
                if (grasas) nutritionItems.push({ key: 'FAT', val: grasas });
                
                if (nutritionItems.length > 0) {
                    nutritionHtml = `
                        <div style="margin-top: 2rem;">
                            <h3 style="font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.15em; color: rgba(255, 255, 255, 0.5); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1rem;">‚ÑπÔ∏è</span>
                                <span>Nutrition Focus</span>
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                ${nutritionItems.map(item => `
                                    <div style="padding: 1rem; background: rgba(255, 255, 255, 0.08); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
                                        <div style="font-size: 0.75rem; text-transform: uppercase; color: rgba(255, 255, 255, 0.4); font-weight: 700; margin-bottom: 0.5rem; letter-spacing: 0.1em;">${item.key}</div>
                                        <div style="font-size: 1.125rem; font-weight: 700; color: rgba(255, 255, 255, 0.95);">${item.val}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Get day name for header
                const dayNameEn = getDayWithDate(selectedDay, 'en');
                
                // Return complete meal card HTML matching zenith design exactly
                return {
                    html: `
                        <div class="meal-card" style="position: relative; overflow: hidden; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 2.5rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);">
                            <!-- Background Accent Blur -->
                            <div style="position: absolute; top: -100px; right: -100px; width: 256px; height: 256px; background: ${isAdult ? '#3B82F6' : '#F97316'}; opacity: 0.2; filter: blur(100px); pointer-events: none; border-radius: 50%; z-index: 0;"></div>
                            
                            <!-- Header with icon and title -->
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; position: relative; z-index: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="padding: 0.75rem; border-radius: 12px; background: ${isAdult ? 'rgba(59, 130, 246, 0.25)' : 'rgba(249, 115, 22, 0.25)'}; color: ${isAdult ? '#3B82F6' : '#F97316'}; font-size: 1.5rem;">
                                        ${isAdult ? 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' : 'üë∂'}
                                    </div>
                                    <span style="font-size: 1rem; font-weight: 700; letter-spacing: 0.2em; text-transform: uppercase; color: ${isAdult ? '#3B82F6' : '#F97316'};">
                                        ${isAdult ? 'ADULTS' : 'CHILDREN'}
                                    </span>
                                </div>
                                <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.4); font-weight: 600; letter-spacing: 0.15em; text-transform: uppercase;">
                                    ${dayNameEn}
                                </div>
                            </div>
                            
                            <!-- Meal Type and Name -->
                            <div style="display: flex; flex-direction: column; gap: 1.25rem; margin-bottom: 2rem; position: relative; z-index: 1;">
                                <div style="display: flex; flex-direction: column;">
                                    <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.15em; color: rgba(255, 255, 255, 0.5); margin-bottom: 0.5rem; font-weight: 600;">
                                        ${mealNames[mealType].es} / ${mealNames[mealType].en}
                                    </span>
                                    <h2 class="meal-name" style="font-family: 'Playfair Display', serif; font-size: 3rem; font-weight: 700; color: #FFFFFF; line-height: 1.2; margin: 0; transition: color 0.3s ease; letter-spacing: -0.02em;">
                                        ${mealName}
                                    </h2>
                                </div>
                                
                                <!-- Description with sparkles -->
                                ${porqueSeleccionada ? `
                                    <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; background: rgba(255, 255, 255, 0.08); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                        <span style="font-size: 1rem; color: #D4AF37; flex-shrink: 0;">‚ú®</span>
                                        <p style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.8); line-height: 1.7; font-style: italic; margin: 0;">
                                            ${porqueSeleccionada}
                                        </p>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Stats bar with borders -->
                            <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; padding: 1.25rem 0; border-top: 1px solid rgba(255, 255, 255, 0.08); border-bottom: 1px solid rgba(255, 255, 255, 0.08); margin-bottom: 2rem; position: relative; z-index: 1;">
                                ${prepTime ? `
                                    <div style="display: flex; align-items: center; gap: 0.75rem; color: rgba(255, 255, 255, 0.7);">
                                        <span style="font-size: 1.25rem;">‚è±Ô∏è</span>
                                        <span style="font-size: 1rem; font-weight: 600;">${prepTime} min</span>
                                    </div>
                                ` : ''}
                                ${calories ? `
                                    <div style="display: flex; align-items: center; gap: 0.75rem; color: rgba(255, 255, 255, 0.7);">
                                        <span style="font-size: 1.25rem;">üî•</span>
                                        <span style="font-size: 1rem; font-weight: 600;">${calories} kcal</span>
                                    </div>
                                ` : ''}
                                ${ingredients.length > 0 ? `
                                    <div style="display: flex; align-items: center; gap: 0.75rem; color: rgba(255, 255, 255, 0.7);">
                                        <span style="font-size: 1.25rem;">üç¥</span>
                                        <span style="font-size: 1rem; font-weight: 600;">${ingredients.length} Items</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Ingredients Section -->
                            ${ingredientsBadgesHtml ? `
                                <div style="margin-bottom: 2rem; position: relative; z-index: 1;">
                                    <h3 style="font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.15em; color: rgba(255, 255, 255, 0.5); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
                                        <span style="font-size: 1rem;">‚úì</span>
                                        <span>Ingredients</span>
                                    </h3>
                                    ${ingredientsBadgesHtml}
                                </div>
                            ` : ''}
                            
                            <!-- Nutrition Focus -->
                            ${nutritionHtml}
                            
                            <!-- Instructions -->
                            ${instrucciones ? `
                                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.08); position: relative; z-index: 1;">
                                    <div style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.5); margin-bottom: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>üìñ</span>
                                        <span>Preparation</span>
                                    </div>
                                    <div style="font-size: 1rem; color: rgba(255, 255, 255, 0.85); line-height: 1.8;">
                                        ${instrucciones}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Adaptations -->
                            ${adaptaciones ? `
                                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(212, 175, 55, 0.12); border-radius: 12px; border: 1px solid rgba(212, 175, 55, 0.25); position: relative; z-index: 1;">
                                    <div style="font-size: 0.875rem; color: #D4AF37; font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em;">‚ú® Adaptations</div>
                                    <div style="font-size: 0.95rem; color: rgba(255, 255, 255, 0.8); line-height: 1.7;">${adaptaciones}</div>
                                </div>
                            ` : ''}
                            
                            <!-- Notes -->
                            ${notas ? `
                                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(138, 161, 147, 0.12); border-radius: 12px; border: 1px solid rgba(138, 161, 147, 0.25); position: relative; z-index: 1;">
                                    <div style="font-size: 0.95rem; color: #8AA193; line-height: 1.7; font-weight: 500;">
                                        üí° ${notas}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `,
                    recipeBase: recipeBase
                };
            }
            
            let adultosHtml = '';
            let ninosHtml = '';
            let adultRecipes = [];
            let childRecipes = [];

            // ADULTOS MENU
            if (currentMenu.menu_adultos && currentMenu.menu_adultos.dias) {
                console.log('[TV] About to call getDayDataFromMenu for adults with selectedDay:', selectedDay);
                console.log('[TV] menu_adultos.dias type:', typeof currentMenu.menu_adultos.dias);
                console.log('[TV] menu_adultos.dias keys:', Object.keys(currentMenu.menu_adultos.dias));
                try {
                    const adultDayData = getDayDataFromMenu(currentMenu.menu_adultos.dias, selectedDay);
                    console.log('[TV] Adult day data for', selectedDay, ':', adultDayData);
                    console.log('[TV] Available day keys in menu:', Object.keys(currentMenu.menu_adultos.dias));
                if (adultDayData) {
                    adultosHtml += `
                        <div class="menu-panel adults">
                            <div class="meal-grid">
                    `;
                    
                    // Render meals asynchronously to fetch recipe URLs
                    const adultMeals = ['desayuno', 'comida', 'cena'].filter(mealType => adultDayData[mealType]);
                    console.log('[TV] Adult meals to render:', adultMeals);
                    for (const mealType of adultMeals) {
                        const meal = adultDayData[mealType];
                        console.log('[TV] Rendering adult meal:', mealType, meal);
                        const result = await renderMealCard(meal, mealType, mealNames, true);
                        console.log('[TV] Render result for', mealType, ':', result ? 'OK' : 'FAILED');
                        if (result && result.html) {
                            console.log('[TV] Adding HTML for', mealType, ', length:', result.html.length);
                            adultosHtml += result.html;
                            if (result.recipeBase && result.recipeBase !== 'Original' && result.recipeBase !== '') {
                                adultRecipes.push(result.recipeBase);
                            }
                        } else {
                            console.error('[TV] Failed to render meal card for', mealType);
                        }
                    }
                    
                    adultosHtml += `</div></div>`;
                } else {
                    console.log('[TV] No adult day data for', selectedDay);
                    adultosHtml = `<div class="menu-panel adults"><div class="panel-header"><div class="panel-title adults"><span class="emoji">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> ADULTS</div></div><div style="text-align: center; padding: 4rem; color: var(--silver); font-size: 2rem;">No menu available</div></div>`;
                }
                } catch (error) {
                    console.error('[TV] Error in getDayDataFromMenu for adults:', error);
                    adultosHtml = `<div class="menu-panel adults"><div class="panel-header"><div class="panel-title adults"><span class="emoji">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> ADULTS</div></div><div style="text-align: center; padding: 4rem; color: var(--silver); font-size: 2rem;">Error loading menu</div></div>`;
                }
            } else {
                console.log('[TV] No menu_adultos.dias structure');
                adultosHtml = `<div class="menu-panel adults"><div class="panel-header"><div class="panel-title adults"><span class="emoji">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> ADULTS</div></div><div style="text-align: center; padding: 4rem; color: var(--silver); font-size: 2rem;">No menu structure</div></div>`;
            }
            
            // NI√ëOS MENU
            if (currentMenu.menu_ninos && currentMenu.menu_ninos.dias) {
                console.log('[TV] About to call getDayDataFromMenu for children with selectedDay:', selectedDay);
                console.log('[TV] menu_ninos.dias type:', typeof currentMenu.menu_ninos.dias);
                console.log('[TV] menu_ninos.dias keys:', Object.keys(currentMenu.menu_ninos.dias));
                try {
                    const childDayData = getDayDataFromMenu(currentMenu.menu_ninos.dias, selectedDay);
                    console.log('[TV] Child day data for', selectedDay, ':', childDayData);
                    console.log('[TV] Available day keys in children menu:', Object.keys(currentMenu.menu_ninos.dias));
                if (childDayData) {
                    ninosHtml += `
                        <div class="menu-panel children">
                            <div class="meal-grid">
                    `;
                    
                    // Render meals asynchronously to fetch recipe URLs
                    const childMeals = ['desayuno', 'comida', 'merienda', 'cena'].filter(mealType => childDayData[mealType]);
                    console.log('[TV] Child meals to render:', childMeals);
                    for (const mealType of childMeals) {
                        const meal = childDayData[mealType];
                        console.log('[TV] Rendering child meal:', mealType, meal);
                        const result = await renderMealCard(meal, mealType, mealNames, false);
                        console.log('[TV] Render result for', mealType, ':', result ? 'OK' : 'FAILED');
                        if (result && result.html) {
                            console.log('[TV] Adding HTML for', mealType, ', length:', result.html.length);
                            ninosHtml += result.html;
                            if (result.recipeBase && result.recipeBase !== 'Original' && result.recipeBase !== '') {
                                childRecipes.push(result.recipeBase);
                            }
                        } else {
                            console.error('[TV] Failed to render meal card for', mealType);
                        }
                    }
                    
                    ninosHtml += `</div></div>`;
                } else {
                    console.log('[TV] No child day data for', selectedDay);
                    ninosHtml = `<div class="menu-panel children"><div class="panel-header"><div class="panel-title children"><span class="emoji">üë∂</span> CHILDREN</div></div><div style="text-align: center; padding: 4rem; color: var(--silver); font-size: 2rem;">No menu available</div></div>`;
                }
                } catch (error) {
                    console.error('[TV] Error in getDayDataFromMenu for children:', error);
                    ninosHtml = `<div class="menu-panel children"><div class="panel-header"><div class="panel-title children"><span class="emoji">üë∂</span> CHILDREN</div></div><div style="text-align: center; padding: 4rem; color: var(--silver); font-size: 2rem;">Error loading menu</div></div>`;
                }
            } else {
                console.log('[TV] No menu_ninos.dias structure');
                ninosHtml = `<div class="menu-panel children"><div class="panel-header"><div class="panel-title children"><span class="emoji">üë∂</span> CHILDREN</div></div><div style="text-align: center; padding: 4rem; color: var(--silver); font-size: 2rem;">No menu structure</div></div>`;
            }
            
            // Collect all recipes from both menus (use the ones we already collected)
            const allRecipes = [...new Set([...adultRecipes, ...childRecipes])];
            
            // Generate QR codes for recipes in top bar
            generateRecipeQRCodes(allRecipes);
            
            let finalHtml = `
                ${adultosHtml}
                <div class="divider"></div>
                ${ninosHtml}
            `;
            
            console.log('[TV] Final HTML length:', finalHtml.length);
            console.log('[TV] Adult HTML length:', adultosHtml.length);
            console.log('[TV] Child HTML length:', ninosHtml.length);
            console.log('[TV] About to set innerHTML');
            
            container.innerHTML = finalHtml;
            
            console.log('[TV] innerHTML set successfully');
            console.log('[TV] Container children count:', container.children.length);
            
            // Force a reflow to ensure rendering
            void container.offsetHeight;
        }

        function showNoMenu() {
            const container = document.getElementById('menu-content');
            container.innerHTML = `
                <div class="no-menu" style="grid-column: 1 / -1;">
                    <h2>No Menu Available</h2>
                    <p>Please generate a menu first</p>
                </div>
            `;
        }

        // Initialize
        function initialize() {
            // Always start with today's day
            selectedDay = getCurrentDayName();
            console.log('[TV] Initializing with today:', selectedDay);
            
            updateDateTime();
            updateWeather();
            generateQRCode();
            updateWeekNav();
            loadMenu();
            
            // Update clock every second
            setInterval(updateDateTime, 1000);
            
            // Auto-refresh menu every 5 minutes
            setInterval(loadMenu, 300000);
        }

        // Start when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
